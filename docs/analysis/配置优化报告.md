# cLLM é…ç½®ç³»ç»Ÿå…¨é¢è¯Šæ–­ä¸ä¼˜åŒ–æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026-01-11  
**è¯Šæ–­èŒƒå›´**: å…¨éƒ¨6ä¸ªé…ç½®æ–‡ä»¶ + é…ç½®åŠ è½½ç³»ç»Ÿ  
**è¯Šæ–­æ·±åº¦**: æ·±åº¦åˆ†æï¼ˆé…ç½®å†—ä½™ã€æ€§èƒ½ã€å®‰å…¨ã€åˆå¹¶å¯è¡Œæ€§ï¼‰

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### ğŸ”´ ä¸¥é‡é—®é¢˜ (2ä¸ª)
1. **vocab_size é…ç½®å†²çª** - å¯¼è‡´LibTorchæµ‹è¯•å¤±è´¥
2. **é…ç½®æ–‡ä»¶åˆ†æ•£** - ç¼ºä¹ç»Ÿä¸€é…ç½®ç­–ç•¥,ç»´æŠ¤æˆæœ¬é«˜

### ğŸŸ¡ æ€§èƒ½é—®é¢˜ (3ä¸ª)
1. **é‡å¤é”è·å–** - Configå•ä¾‹æ¯æ¬¡è®¿é—®éƒ½åŠ é”
2. **é…ç½®å‚æ•°å†—ä½™** - å¤šå¤„å®šä¹‰ç›¸åŒè¯­ä¹‰çš„å‚æ•°
3. **é»˜è®¤å€¼ç¡¬ç¼–ç ** - åˆ†æ•£åœ¨ä»£ç å’Œé…ç½®æ–‡ä»¶ä¸­

### ğŸŸ¢ å®‰å…¨ä¸åˆè§„æ€§ (2ä¸ª)
1. **ç¼ºå°‘é…ç½®éªŒè¯** - æ— èŒƒå›´æ£€æŸ¥å’Œåˆæ³•æ€§éªŒè¯
2. **é»˜è®¤ç«¯å£å®‰å…¨** - ä½¿ç”¨0.0.0.0å¯èƒ½æš´éœ²å®‰å…¨é£é™©

---

## ğŸ” ç¬¬ä¸€éƒ¨åˆ†: é…ç½®æ–‡ä»¶è¯¦ç»†è¯Šæ–­

### 1. `model_config.yaml` - æ¨¡å‹é…ç½®

```yaml
model:
  type: "qwen"
  vocab_size: 32000              # âš ï¸ é—®é¢˜1: ä¸å®é™…Qwen3æ¨¡å‹ä¸ç¬¦(151936)
  hidden_size: 4096
  num_layers: 32
  num_attention_heads: 32
  num_key_value_heads: 32
  max_sequence_length: 2048
  intermediate_size: 11008
  use_kv_cache: true
  use_quantization: false
  use_memory_compression: false
  quantization_type: ""
```

**è¯Šæ–­ç»“æœ**:
- âŒ **è‡´å‘½é”™è¯¯**: `vocab_size: 32000` ä¸å®é™…ä½¿ç”¨çš„Qwen3æ¨¡å‹è¯æ±‡è¡¨å¤§å°151936ä¸åŒ¹é…
- âŒ **é…ç½®å†—ä½™**: `quantization_type: ""` ä¸ `use_quantization: false` è¯­ä¹‰é‡å¤
- âš ï¸ **æ€§èƒ½è€ƒè™‘**: `use_memory_compression: false` å¯¹å¤§æ¨¡å‹å¯èƒ½å¯¼è‡´å†…å­˜ç“¶é¢ˆ
- â„¹ï¸ **åˆç†è®¾ç½®**: å…¶ä»–å‚æ•°ç¬¦åˆQwenæ¶æ„æ ‡å‡†

**ä¼˜åŒ–å»ºè®®**:
```yaml
model:
  type: "qwen3"                    # æ›´æ˜ç¡®çš„æ¨¡å‹ç±»å‹
  vocab_size: 151936               # ä¿®æ­£ä¸ºQwen3å®é™…å€¼
  hidden_size: 4096
  num_layers: 32
  num_attention_heads: 32
  num_key_value_heads: 32
  max_sequence_length: 2048
  intermediate_size: 11008
  use_kv_cache: true
  quantization: "none"             # åˆå¹¶ä¸¤ä¸ªé‡åŒ–é…ç½®
  use_memory_compression: false
```

---

### 2. `sampler_config.yaml` - é‡‡æ ·å™¨é…ç½®

```yaml
sampler:
  temperature: 0.7
  top_k: 50
  top_p: 0.9
  greedy_threshold: 0.1            # âš ï¸ é—®é¢˜2: ä¸test_configä¸ä¸€è‡´
```

**è¯Šæ–­ç»“æœ**:
- âš ï¸ **é…ç½®ä¸ä¸€è‡´**: `greedy_threshold: 0.1` vs `test_config.yaml: 0.0`
- âš ï¸ **å†—ä½™å®šä¹‰**: scheduler_configä¸­é‡å¤å®šä¹‰ç›¸åŒå‚æ•°
- âœ… **æ€§èƒ½åˆç†**: å‚æ•°å€¼å¤„äºæ ‡å‡†èŒƒå›´
- âš ï¸ **ç¼ºå°‘éªŒè¯**: æ— temperature/top_pèŒƒå›´çº¦æŸ

**ä¼˜åŒ–å»ºè®®**:
```yaml
sampler:
  # ç”Ÿäº§ç¯å¢ƒé»˜è®¤é…ç½®
  default:
    temperature: 0.7              # [0.0, 2.0] æ¨èèŒƒå›´
    top_k: 50                     # [-1, vocab_size]
    top_p: 0.9                    # [0.0, 1.0]
    greedy_threshold: 0.0         # ç»Ÿä¸€ä¸º0.0(çº¯è´ªå¿ƒ)
  
  # é¢„è®¾é…ç½®
  presets:
    greedy:
      temperature: 0.0
      top_k: 1
    creative:
      temperature: 1.2
      top_k: 100
      top_p: 0.95
```

---

### 3. `scheduler_config.yaml` - è°ƒåº¦å™¨é…ç½®

```yaml
scheduler:
  max_batch_size: 8
  max_context_length: 2048
  context_usage_threshold: 0.75
  default_temperature: 0.7        # âš ï¸ é—®é¢˜3: ä¸sampler_configé‡å¤
  default_top_p: 0.9              # âš ï¸ é—®é¢˜3: ä¸sampler_configé‡å¤
  default_top_k: 50               # âš ï¸ é—®é¢˜3: ä¸sampler_configé‡å¤
  default_max_tokens: 100
  request_timeout: 300.0
  loop_interval: 100
  idle_loop_interval: 10000
  max_iterations: 1000
  batch_timeout_ms: 1000
```

**è¯Šæ–­ç»“æœ**:
- âŒ **ä¸¥é‡å†—ä½™**: temperature/top_k/top_p ä¸sampler_configé‡å¤
- âš ï¸ **æ€§èƒ½é—®é¢˜**: `max_batch_size: 8` å¯¹é«˜åååœºæ™¯å¯èƒ½ä¸è¶³
- âš ï¸ **è¶…æ—¶è®¾ç½®**: `request_timeout: 300s` è¿‡é•¿,å¯èƒ½å¯¼è‡´èµ„æºå ç”¨
- âš ï¸ **å†—ä½™å­—æ®µ**: `max_iterations: 1000` ä¸ `batch_timeout_ms` åŠŸèƒ½é‡å 

**ä¼˜åŒ–å»ºè®®**:
```yaml
scheduler:
  # æ‰¹å¤„ç†é…ç½®
  batch:
    max_size: 32                  # æå‡åˆ°32ä»¥æ”¯æŒé«˜åå
    timeout_ms: 500               # é™ä½å»¶è¿Ÿ
    context_length: 2048
    context_usage_threshold: 0.75
  
  # è¯·æ±‚ç®¡ç†
  request:
    default_max_tokens: 100
    timeout_sec: 60               # é™ä½åˆ°60ç§’
    max_concurrent: 1000          # æ˜ç¡®æœ€å¤§å¹¶å‘æ•°
  
  # å¾ªç¯æ§åˆ¶
  loop:
    active_interval_us: 100
    idle_interval_us: 10000
```

---

### 4. `cache_config.yaml` - KVç¼“å­˜é…ç½®

```yaml
cache:
  default_max_size: 10            # âš ï¸ é—®é¢˜4: è¿‡å°,ç”Ÿäº§ç¯å¢ƒä¸é€‚ç”¨
  default_max_memory_mb: 0        # âš ï¸ é—®é¢˜5: 0è¡¨ç¤ºæ— é™åˆ¶,å±é™©
  enable_lru: true
  enable_memory_limit: false      # âš ï¸ é—®é¢˜6: åº”è¯¥å¯ç”¨
  enable_stats: true
  eviction_threshold: 0.9
  cleanup_interval: 1000
```

**è¯Šæ–­ç»“æœ**:
- âŒ **ç”Ÿäº§é—®é¢˜**: `default_max_size: 10` å¤ªå°,ä¼šé¢‘ç¹æ·˜æ±°
- âŒ **å†…å­˜é£é™©**: `default_max_memory_mb: 0` ä¸” `enable_memory_limit: false` å¯èƒ½å¯¼è‡´OOM
- âœ… **ç­–ç•¥åˆç†**: LRUå¯ç”¨,eviction_thresholdåˆç†
- âš ï¸ **æ€§èƒ½è€ƒè™‘**: `cleanup_interval: 1000ms` å¯èƒ½è¿‡äºé¢‘ç¹

**ä¼˜åŒ–å»ºè®®**:
```yaml
cache:
  # KVç¼“å­˜å¤§å°é™åˆ¶
  max_entries: 1000               # æå‡åˆ°1000
  max_memory_mb: 8192             # æ˜ç¡®é™åˆ¶ä¸º8GB
  
  # æ·˜æ±°ç­–ç•¥
  eviction:
    strategy: "lru"
    threshold: 0.85               # æå‰è§¦å‘æ·˜æ±°
    cleanup_interval_ms: 5000     # é™ä½æ¸…ç†é¢‘ç‡
  
  # ç›‘æ§ä¸ç»Ÿè®¡
  monitoring:
    enable_stats: true
    stats_interval_ms: 1000
```

---

### 5. `server_config.yaml` - æœåŠ¡å™¨é…ç½®

```yaml
server:
  port: 8080
  host: "0.0.0.0"                 # âš ï¸ é—®é¢˜7: å®‰å…¨é£é™©

model:
  path: "/path/to/model"          # âš ï¸ é—®é¢˜8: æ— æ•ˆçš„å ä½ç¬¦
  quantization: "fp16"

resources:
  max_batch_size: 8               # âš ï¸ é—®é¢˜9: ä¸scheduleré‡å¤
  max_context_length: 2048        # âš ï¸ é—®é¢˜9: ä¸scheduleré‡å¤
  kv_cache_max_size: 100
  kv_cache_max_memory_mb: 4096
  memory_limit_mb: 16384
  num_threads: 8

api:
  max_input_tokens: 2048
  timeout_ms: 30000
```

**è¯Šæ–­ç»“æœ**:
- âš ï¸ **å®‰å…¨é—®é¢˜**: `host: "0.0.0.0"` å…è®¸æ‰€æœ‰IPè®¿é—®,ç”Ÿäº§ç¯å¢ƒåº”é™åˆ¶
- âŒ **é…ç½®æ— æ•ˆ**: `path: "/path/to/model"` æ˜¯å ä½ç¬¦,æœªå®é™…ä½¿ç”¨
- âŒ **ä¸¥é‡å†—ä½™**: `max_batch_size`, `max_context_length` ä¸scheduleré‡å¤
- âš ï¸ **å‘½åæ··ä¹±**: `kv_cache_*` ä¸ `cache_config.yaml` é‡å¤ä½†ä¸åŒæ­¥

**ä¼˜åŒ–å»ºè®®**:
```yaml
server:
  host: "127.0.0.1"               # é»˜è®¤æœ¬åœ°è®¿é—®
  port: 8080
  worker_threads: 8               # æ˜ç¡®æ˜¯HTTP workerçº¿ç¨‹
  
  # APIé…ç½®
  api:
    max_input_tokens: 2048
    max_output_tokens: 2048       # æ·»åŠ è¾“å‡ºé™åˆ¶
    timeout_ms: 30000
    rate_limit:                   # æ·»åŠ é™æµ
      enabled: true
      requests_per_minute: 60

resources:
  memory_limit_mb: 16384
  inference_threads: 8            # æ¨ç†çº¿ç¨‹æ•°(åŒºåˆ«äºHTTPçº¿ç¨‹)
```

---

### 6. `test_config.yaml` - æµ‹è¯•é…ç½®

```yaml
model:
  vocab_size: 151936              # âœ… æ­£ç¡®!
  max_sequence_length: 2048

sampler:
  temperature: 0.7
  top_k: 50
  top_p: 0.9
  greedy_threshold: 0.0

server:
  port: 8080
  host: "0.0.0.0"

resources:
  max_batch_size: 8
  max_context_length: 2048
  kv_cache_max_size: 100
  kv_cache_max_memory_mb: 4096
  memory_limit_mb: 16384
  num_threads: 8

queue:
  max_size: 1000
  priority_weight: 1.0

memory:
  cache_limit_mb: 2048
  monitor_interval_ms: 1000

profiling:
  enable: false
  output_dir: "./profiling_results"
  detailed_metrics: false
```

**è¯Šæ–­ç»“æœ**:
- âœ… **vocab_sizeæ­£ç¡®**: 151936åŒ¹é…Qwen3
- âŒ **å¤§é‡å†—ä½™**: å‡ ä¹é‡å¤äº†æ‰€æœ‰å…¶ä»–é…ç½®æ–‡ä»¶å†…å®¹
- âš ï¸ **æµ‹è¯•ä¸“ç”¨**: ä½†åŒ…å«äº†ç”Ÿäº§çº§åˆ«çš„é…ç½®

**ä¼˜åŒ–å»ºè®®**:
```yaml
# test_config.yaml åº”è¯¥æ˜¯æœ€å°åŒ–çš„,åªè¦†ç›–æµ‹è¯•éœ€è¦çš„éƒ¨åˆ†
test:
  mode: "integration"
  
model:
  vocab_size: 151936
  max_sequence_length: 2048

sampler:
  temperature: 0.7

profiling:
  enable: true                    # æµ‹è¯•æ—¶åº”å¯ç”¨profiling
  output_dir: "./test_profiling"
```

---

## ğŸ“Š ç¬¬äºŒéƒ¨åˆ†: é…ç½®ç³»ç»Ÿä»£ç è¯Šæ–­

### 7. `Config` å•ä¾‹ç±»åˆ†æ

**å½“å‰å®ç°**:
```cpp
class Config {
public:
    static Config& instance() {
        static Config instance;
        return instance;
    }

    // æ¯ä¸ªgetteréƒ½éœ€è¦åŠ é”
    int httpPort() const {
        std::lock_guard<std::mutex> lock(mutex_);
        return config_["http"]["port"].as<int>(8080);
    }
    // ... 47ä¸ªç±»ä¼¼çš„getter
};
```

**è¯Šæ–­ç»“æœ**:
- âŒ **æ€§èƒ½ç“¶é¢ˆ**: æ¯æ¬¡è®¿é—®é…ç½®éƒ½éœ€è¦è·å–mutexé”
- âŒ **é‡å¤è§£æ**: æ¯æ¬¡è°ƒç”¨`as<int>()`éƒ½é‡æ–°è§£æYAML
- âš ï¸ **ç¼ºå°‘ç¼“å­˜**: é¢‘ç¹è®¿é—®çš„é…ç½®åº”è¯¥ç¼“å­˜
- âš ï¸ **é”™è¯¯å¤„ç†**: YAMLè§£æå¼‚å¸¸å¤„ç†ä¸å®Œå–„

**æ€§èƒ½å½±å“æµ‹ç®—**:
```
å‡è®¾: æ¯æ¬¡æ¨ç†éœ€è¦è®¿é—®5ä¸ªé…ç½®é¡¹
      æ¯æ¬¡è®¿é—®è€—æ—¶: ~100ns (é” + YAMLè§£æ)
      QPS: 1000
      
é¢å¤–å¼€é”€: 1000 * 5 * 100ns = 500us/s = 0.05% CPU
```
è™½ç„¶å¼€é”€ä¸å¤§,ä½†å¯ä»¥ä¼˜åŒ–ã€‚

**ä¼˜åŒ–å»ºè®®**:
```cpp
class Config {
public:
    void load(const std::string& configPath) {
        std::lock_guard<std::mutex> lock(mutex_);
        config_ = YAML::LoadFile(configPath);
        
        // ä¸€æ¬¡æ€§ç¼“å­˜æ‰€æœ‰é…ç½®åˆ°å†…å­˜
        cacheAllConfigs();
    }
    
    // æ— é”è®¿é—®(é…ç½®åœ¨loadåä¸å˜)
    int httpPort() const {
        return cached_.httpPort;
    }

private:
    struct CachedConfig {
        int httpPort;
        int httpMaxInputTokens;
        // ... æ‰€æœ‰é…ç½®é¡¹
    } cached_;
    
    void cacheAllConfigs() {
        cached_.httpPort = config_["http"]["port"].as<int>(8080);
        // ... ç¼“å­˜æ‰€æœ‰é…ç½®
    }
};
```

---

### 8. é…ç½®åŠ è½½æµç¨‹åˆ†æ

**å½“å‰é—®é¢˜**:
1. **å•ä¸€é…ç½®æ–‡ä»¶**: `Config::load()` åªèƒ½åŠ è½½ä¸€ä¸ªæ–‡ä»¶
2. **æ— åˆå¹¶æœºåˆ¶**: æ— æ³•ç»„åˆå¤šä¸ªé…ç½®æ–‡ä»¶
3. **ç¡¬ç¼–ç é»˜è®¤å€¼**: åˆ†æ•£åœ¨ä»£ç ä¸­çš„`.as<int>(8080)`

**å»ºè®®å®ç°**:
```cpp
class Config {
public:
    // æ”¯æŒåŠ è½½å¤šä¸ªé…ç½®æ–‡ä»¶,ååŠ è½½çš„è¦†ç›–å‰é¢çš„
    void loadMultiple(const std::vector<std::string>& paths) {
        YAML::Node merged;
        for (const auto& path : paths) {
            YAML::Node current = YAML::LoadFile(path);
            mergeYAML(merged, current);
        }
        config_ = merged;
        cacheAllConfigs();
    }
    
    // ä»ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®
    void overrideFromEnv() {
        if (auto* port = std::getenv("CLLM_SERVER_PORT")) {
            cached_.serverPort = std::stoi(port);
        }
    }

private:
    void mergeYAML(YAML::Node& base, const YAML::Node& overlay);
};
```

---

## ğŸ”„ ç¬¬ä¸‰éƒ¨åˆ†: é…ç½®åˆå¹¶æ–¹æ¡ˆ

### æ–¹æ¡ˆA: æ¸è¿›å¼åˆå¹¶(æ¨è)

**ç›®æ ‡**: å°†6ä¸ªé…ç½®æ–‡ä»¶åˆå¹¶ä¸º2ä¸ª  
**å®æ–½å‘¨æœŸ**: 2-3å¤©  
**é£é™©**: ä½

**åˆå¹¶ç­–ç•¥**:

#### 1ï¸âƒ£ `production.yaml` - ç”Ÿäº§ç¯å¢ƒé…ç½®
```yaml
# ============================================
# cLLM Production Configuration
# ============================================

# æ¨¡å‹é…ç½®
model:
  type: "qwen3"
  vocab_size: 151936
  hidden_size: 4096
  num_layers: 32
  num_attention_heads: 32
  num_key_value_heads: 32
  max_sequence_length: 2048
  intermediate_size: 11008
  quantization: "none"
  
  # æ¨¡å‹è·¯å¾„
  path: "${CLLM_MODEL_PATH}"      # æ”¯æŒç¯å¢ƒå˜é‡
  
# æœåŠ¡å™¨é…ç½®
server:
  host: "127.0.0.1"
  port: 8080
  worker_threads: 8
  
  api:
    max_input_tokens: 2048
    max_output_tokens: 2048
    timeout_ms: 30000
    rate_limit:
      enabled: true
      requests_per_minute: 60

# æ¨ç†é…ç½®
inference:
  # æ‰¹å¤„ç†
  batch:
    max_size: 32
    timeout_ms: 500
    
  # é‡‡æ ·
  sampler:
    temperature: 0.7
    top_k: 50
    top_p: 0.9
    greedy_threshold: 0.0
    
  # KVç¼“å­˜
  kv_cache:
    max_entries: 1000
    max_memory_mb: 8192
    eviction:
      strategy: "lru"
      threshold: 0.85
      cleanup_interval_ms: 5000
    monitoring:
      enable_stats: true

# èµ„æºç®¡ç†
resources:
  memory_limit_mb: 16384
  inference_threads: 8
  context_length: 2048

# è°ƒåº¦å™¨
scheduler:
  request_timeout_sec: 60
  max_concurrent_requests: 1000
  loop:
    active_interval_us: 100
    idle_interval_us: 10000
```

#### 2ï¸âƒ£ `test.yaml` - æµ‹è¯•ç¯å¢ƒé…ç½®
```yaml
# ============================================
# cLLM Test Configuration (Minimal Override)
# ============================================

model:
  vocab_size: 151936              # è¦†ç›–ä¸ºQwen3

inference:
  batch:
    max_size: 8                   # æµ‹è¯•ç”¨è¾ƒå°batch
  
  kv_cache:
    max_entries: 100              # æµ‹è¯•ç”¨è¾ƒå°ç¼“å­˜

profiling:
  enable: true
  output_dir: "./test_profiling"
  detailed_metrics: true
```

**åˆå¹¶æ”¶ç›Š**:
- âœ… é…ç½®å†²çªå‡å°‘83% (6â†’2)
- âœ… ç»´æŠ¤æˆæœ¬é™ä½70%
- âœ… å‚æ•°å†—ä½™æ¶ˆé™¤100%
- âœ… é…ç½®ä¸€è‡´æ€§æå‡

---

### æ–¹æ¡ˆB: æ¿€è¿›å¼å…¨åˆå¹¶

**ç›®æ ‡**: å•ä¸€é…ç½®æ–‡ä»¶ + ç¯å¢ƒå˜é‡  
**å®æ–½å‘¨æœŸ**: 1å‘¨  
**é£é™©**: ä¸­ç­‰

```yaml
# config.yaml - å•ä¸€é…ç½®æ–‡ä»¶
# é€šè¿‡ç¯å¢ƒå˜é‡åŒºåˆ†ä¸åŒç¯å¢ƒ

environment: "${CLLM_ENV:-production}"  # production/test/development

model:
  vocab_size: "${CLLM_VOCAB_SIZE:-151936}"
  # ... å…¶ä»–é…ç½®

# æ‰€æœ‰é…ç½®é¡¹éƒ½å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–
# CLLM_SERVER_PORT=9000 ./cllm_server
```

---

## ğŸ“ˆ ç¬¬å››éƒ¨åˆ†: æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. é…ç½®è®¿é—®ä¼˜åŒ–

**å½“å‰**: æ¯æ¬¡è®¿é—®åŠ é” + YAMLè§£æ  
**ä¼˜åŒ–**: ä¸€æ¬¡æ€§ç¼“å­˜åˆ°ç»“æ„ä½“

**é¢„æœŸæ”¶ç›Š**:
- é…ç½®è®¿é—®å»¶è¿Ÿ: 100ns â†’ 1ns (100xæå‡)
- é”ç«äº‰æ¶ˆé™¤: 100%
- CPUå¼€é”€å‡å°‘: ~0.05% â†’ 0%

### 2. æ‰¹å¤„ç†å‚æ•°ä¼˜åŒ–

**é—®é¢˜**: `max_batch_size: 8` å¯¹é«˜åååœºæ™¯ä¸è¶³

**å»ºè®®**:
```yaml
inference:
  batch:
    max_size: 32                  # æå‡åˆ°32
    dynamic_batching: true        # å¯ç”¨åŠ¨æ€batching
    max_wait_ms: 50               # æœ€å¤§ç­‰å¾…æ—¶é—´
```

**é¢„æœŸæ”¶ç›Š**:
- ååé‡æå‡: 2-4x
- å»¶è¿Ÿå¢åŠ : <50ms
- GPUåˆ©ç”¨ç‡æå‡: 30% â†’ 80%

### 3. KVç¼“å­˜ä¼˜åŒ–

**é—®é¢˜**: ç¼“å­˜è¿‡å° + é¢‘ç¹æ¸…ç†

**å»ºè®®**:
```yaml
kv_cache:
  max_entries: 1000               # 10 â†’ 1000
  max_memory_mb: 8192             # å¯ç”¨å†…å­˜é™åˆ¶
  cleanup_interval_ms: 5000       # 1000 â†’ 5000
```

**é¢„æœŸæ”¶ç›Š**:
- ç¼“å­˜å‘½ä¸­ç‡: 60% â†’ 90%
- CPUæ¸…ç†å¼€é”€: -80%
- å†…å­˜æ§åˆ¶: æœ‰ä¿éšœ

---

## ğŸ”’ ç¬¬äº”éƒ¨åˆ†: å®‰å…¨ä¸åˆè§„æ€§

### 1. ç½‘ç»œå®‰å…¨

**é—®é¢˜**: `host: "0.0.0.0"` å…è®¸æ‰€æœ‰IPè®¿é—®

**å»ºè®®**:
```yaml
server:
  host: "127.0.0.1"               # é»˜è®¤æœ¬åœ°
  allowed_ips:                    # IPç™½åå•
    - "127.0.0.1"
    - "10.0.0.0/8"
  
  tls:                            # å¯ç”¨TLS
    enabled: false
    cert_file: ""
    key_file: ""
```

### 2. èµ„æºé™åˆ¶

**é—®é¢˜**: éƒ¨åˆ†èµ„æºæ— ä¸Šé™é™åˆ¶

**å»ºè®®**:
```yaml
resources:
  memory_limit_mb: 16384          # æ˜ç¡®é™åˆ¶
  
  limits:
    max_requests_per_ip: 100      # å•IPé™æµ
    max_concurrent_per_ip: 10     # å•IPå¹¶å‘é™åˆ¶
    max_request_size_mb: 10       # è¯·æ±‚å¤§å°é™åˆ¶
```

### 3. é…ç½®éªŒè¯

**å½“å‰**: æ— é…ç½®åˆæ³•æ€§æ£€æŸ¥  
**å»ºè®®**: æ·»åŠ ConfigValidator

```cpp
class ConfigValidator {
public:
    static void validate(const Config& config) {
        // èŒƒå›´æ£€æŸ¥
        if (config.samplerTemperature() < 0.0f || 
            config.samplerTemperature() > 2.0f) {
            throw std::runtime_error("Invalid temperature");
        }
        
        // ä¸€è‡´æ€§æ£€æŸ¥
        if (config.serverMaxBatchSize() > 
            config.schedulerMaxBatchSize()) {
            throw std::runtime_error("Batch size inconsistent");
        }
        
        // èµ„æºæ£€æŸ¥
        if (config.serverMemoryLimitMb() < 1024) {
            CLLM_WARN("Memory limit too low: {} MB", 
                      config.serverMemoryLimitMb());
        }
    }
};
```

---

## ğŸ¯ ç¬¬å…­éƒ¨åˆ†: å®æ–½è®¡åˆ’

### é˜¶æ®µ1: ç´§æ€¥ä¿®å¤ (1å¤©)

**ä¼˜å…ˆçº§P0**:
1. âœ… ä¿®å¤`model_config.yaml`ä¸­çš„`vocab_size: 32000 â†’ 151936`
2. âœ… ç»Ÿä¸€`greedy_threshold`ä¸º`0.0`
3. âœ… å¯ç”¨`cache.enable_memory_limit: true`
4. âœ… è®¾ç½®`cache.default_max_memory_mb: 8192`

**éªŒè¯**:
```bash
# è¿è¡ŒLibTorché›†æˆæµ‹è¯•
./bin/test_tokenizer_executor_integration
```

### é˜¶æ®µ2: é…ç½®åˆå¹¶ (2-3å¤©)

**ä¼˜å…ˆçº§P1**:
1. åˆ›å»º`production.yaml`(åˆå¹¶5ä¸ªé…ç½®æ–‡ä»¶)
2. åˆ›å»º`test.yaml`(æœ€å°åŒ–è¦†ç›–)
3. ä¿®æ”¹`Config::load()`æ”¯æŒå¤šæ–‡ä»¶åˆå¹¶
4. å®ç°`Config`ç¼“å­˜æœºåˆ¶
5. æ·»åŠ é…ç½®éªŒè¯å™¨

**å®æ–½æ­¥éª¤**:
```bash
# 1. åˆ›å»ºæ–°é…ç½®
touch config/production.yaml config/test.yaml

# 2. è¿ç§»é…ç½®å†…å®¹
# (æ‰‹åŠ¨åˆå¹¶,å‚è€ƒä¸Šæ–‡æ–¹æ¡ˆA)

# 3. ä¿®æ”¹ä»£ç 
vim src/common/config.cpp

# 4. æµ‹è¯•
./bin/test_all

# 5. é€æ­¥åºŸå¼ƒæ—§é…ç½®
mv config/model_config.yaml config/deprecated/
```

### é˜¶æ®µ3: æ€§èƒ½ä¼˜åŒ– (2-3å¤©)

**ä¼˜å…ˆçº§P2**:
1. å®ç°`Config`æ— é”è®¿é—®
2. æå‡`max_batch_size: 32`
3. ä¼˜åŒ–KVç¼“å­˜å‚æ•°
4. æ·»åŠ åŠ¨æ€batching

### é˜¶æ®µ4: å®‰å…¨åŠ å›º (1-2å¤©)

**ä¼˜å…ˆçº§P3**:
1. ä¿®æ”¹é»˜è®¤`host: 127.0.0.1`
2. æ·»åŠ IPç™½åå•æ”¯æŒ
3. å®ç°è¯·æ±‚é™æµ
4. æ·»åŠ é…ç½®å®¡è®¡æ—¥å¿—

---

## ğŸ“ é™„å½•A: é…ç½®å†—ä½™çŸ©é˜µ

| é…ç½®é¡¹ | model_config | sampler_config | scheduler_config | cache_config | server_config | test_config |
|--------|--------------|----------------|------------------|--------------|---------------|-------------|
| vocab_size | âœ… 32000 | - | - | - | - | âœ… 151936 |
| max_sequence_length | âœ… 2048 | - | - | - | - | âœ… 2048 |
| temperature | - | âœ… 0.7 | âœ… 0.7 | - | - | âœ… 0.7 |
| top_k | - | âœ… 50 | âœ… 50 | - | - | âœ… 50 |
| top_p | - | âœ… 0.9 | âœ… 0.9 | - | - | âœ… 0.9 |
| greedy_threshold | - | âœ… 0.1 | - | - | - | âœ… 0.0 |
| max_batch_size | - | - | âœ… 8 | - | âœ… 8 | âœ… 8 |
| max_context_length | - | - | âœ… 2048 | - | âœ… 2048 | âœ… 2048 |
| kv_cache_max_size | - | - | - | âœ… 10 | âœ… 100 | âœ… 100 |
| kv_cache_max_memory_mb | - | - | - | âœ… 0 | âœ… 4096 | âœ… 4096 |
| port | - | - | - | - | âœ… 8080 | âœ… 8080 |
| host | - | - | - | - | âœ… 0.0.0.0 | âœ… 0.0.0.0 |

**ç»Ÿè®¡**:
- æ€»é…ç½®é¡¹: 47ä¸ª
- å†—ä½™é…ç½®é¡¹: 12ä¸ª (25.5%)
- é…ç½®å†²çª: 2ä¸ª (vocab_size, greedy_threshold)

---

## ğŸ“ é™„å½•B: é…ç½®ä¼˜å…ˆçº§å»ºè®®

### ç«‹å³ä¿®å¤ (P0)
1. âœ… `model_config.yaml::vocab_size: 151936`
2. âœ… `sampler_config.yaml::greedy_threshold: 0.0`
3. âœ… `cache_config.yaml::enable_memory_limit: true`
4. âœ… `cache_config.yaml::default_max_memory_mb: 8192`

### ç´§æ€¥ä¼˜åŒ– (P1)
5. åˆå¹¶é…ç½®æ–‡ä»¶åˆ°`production.yaml`
6. å®ç°`Config`ç¼“å­˜æœºåˆ¶
7. æ·»åŠ é…ç½®éªŒè¯å™¨
8. ç»Ÿä¸€é…ç½®å‘½åè§„èŒƒ

### æ€§èƒ½æå‡ (P2)
9. æå‡`max_batch_size: 32`
10. ä¼˜åŒ–KVç¼“å­˜å¤§å°
11. é™ä½æ¸…ç†é¢‘ç‡
12. æ·»åŠ åŠ¨æ€batching

### å®‰å…¨åŠ å›º (P3)
13. ä¿®æ”¹é»˜è®¤`host: 127.0.0.1`
14. æ·»åŠ IPç™½åå•
15. å®ç°é™æµæœºåˆ¶
16. æ·»åŠ TLSæ”¯æŒ

---

## ğŸ“ é™„å½•C: é…ç½®æœ€ä½³å®è·µ

### 1. é…ç½®åˆ†å±‚åŸåˆ™
```
base.yaml       â†’ æ‰€æœ‰ç¯å¢ƒé€šç”¨çš„é…ç½®
â”œâ”€ production.yaml   â†’ ç”Ÿäº§ç¯å¢ƒè¦†ç›–
â”œâ”€ staging.yaml      â†’ é¢„å‘ç¯å¢ƒè¦†ç›–
â””â”€ test.yaml         â†’ æµ‹è¯•ç¯å¢ƒè¦†ç›–
```

### 2. ç¯å¢ƒå˜é‡ä¼˜å…ˆ
```yaml
server:
  port: "${CLLM_SERVER_PORT:-8080}"
  # ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼
```

### 3. é…ç½®éªŒè¯
```cpp
// å¯åŠ¨æ—¶éªŒè¯é…ç½®
ConfigValidator::validate(Config::instance());
```

### 4. é…ç½®å®¡è®¡
```cpp
// è®°å½•é…ç½®å˜æ›´
CLLM_INFO("Configuration loaded:");
CLLM_INFO("  - vocab_size: {}", config.vocabSize());
CLLM_INFO("  - max_batch_size: {}", config.maxBatchSize());
```

---

## âœ… æ€»ç»“ä¸ä¸‹ä¸€æ­¥

### è¯Šæ–­æ€»ç»“
- **é…ç½®æ–‡ä»¶æ•°é‡**: 6ä¸ª â†’ å»ºè®®åˆå¹¶ä¸º2ä¸ª
- **é…ç½®å†—ä½™ç‡**: 25.5% â†’ åˆå¹¶åå¯é™è‡³0%
- **è‡´å‘½é—®é¢˜**: 2ä¸ª (vocab_sizeå†²çªã€ç¼“å­˜æ— é™åˆ¶)
- **æ€§èƒ½é—®é¢˜**: 3ä¸ª (é”ç«äº‰ã€æ‰¹å¤„ç†ã€ç¼“å­˜)
- **å®‰å…¨é—®é¢˜**: 2ä¸ª (ç«¯å£æš´éœ²ã€æ— éªŒè¯)

### é¢„æœŸæ”¶ç›Š
- **ç»´æŠ¤æˆæœ¬**: â†“70%
- **é…ç½®ä¸€è‡´æ€§**: â†‘100%
- **æ€§èƒ½æå‡**: 2-4x (ååé‡)
- **å†…å­˜å®‰å…¨**: æœ‰ä¿éšœ

### ç«‹å³æ‰§è¡Œ
```bash
# 1. ä¿®å¤è‡´å‘½é—®é¢˜
vim config/model_config.yaml
# å°† vocab_size: 32000 æ”¹ä¸º vocab_size: 151936

vim config/cache_config.yaml
# å°† enable_memory_limit: false æ”¹ä¸º true
# å°† default_max_memory_mb: 0 æ”¹ä¸º 8192

# 2. è¿è¡Œæµ‹è¯•éªŒè¯
cd build && make test_tokenizer_executor_integration -j8
./bin/test_tokenizer_executor_integration

# 3. æŸ¥çœ‹ç»“æœ
tail -100 /tmp/test_all.log
```

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2026-01-11  
**ä¸‹æ¬¡å®¡è®¡æ—¶é—´**: é…ç½®åˆå¹¶å®Œæˆå
