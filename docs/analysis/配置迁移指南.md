# é…ç½®ç³»ç»Ÿè¿ç§»æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†ä»æ—§çš„6ä¸ªé…ç½®æ–‡ä»¶è¿ç§»åˆ°æ–°çš„ç»Ÿä¸€é…ç½®ç³»ç»Ÿçš„å®Œæ•´æŒ‡å—ã€‚

---

## ğŸ“Š å˜æ›´æ‘˜è¦

### é…ç½®æ–‡ä»¶å˜åŒ–
```
æ—§é…ç½® (6ä¸ªæ–‡ä»¶)                  æ–°é…ç½® (2ä¸ªæ–‡ä»¶)
â”œâ”€ model_config.yaml             â”œâ”€ production.yaml (ä¸»é…ç½®)
â”œâ”€ sampler_config.yaml          â””â”€ test.yaml (æµ‹è¯•è¦†ç›–)
â”œâ”€ scheduler_config.yaml
â”œâ”€ cache_config.yaml
â”œâ”€ server_config.yaml
â””â”€ test_config.yaml
```

### å…³é”®å˜æ›´
1. âœ… **vocab_size**: `32000` â†’ `151936` (ä¿®æ­£ä¸ºQwen3å®é™…å€¼)
2. âœ… **greedy_threshold**: ç»Ÿä¸€ä¸º `0.0`
3. âœ… **cache.enable_memory_limit**: `false` â†’ `true`
4. âœ… **cache.default_max_memory_mb**: `0` â†’ `8192`
5. âœ… **cache.default_max_size**: `10` â†’ `1000`
6. âœ… **batch.max_size**: `8` â†’ `32` (æ€§èƒ½ä¼˜åŒ–)

---

## ğŸš€ å¿«é€Ÿè¿ç§»

### æ­¥éª¤1: å¤‡ä»½æ—§é…ç½® (å¯é€‰)
```bash
cd /Users/dannypan/PycharmProjects/xllm/cpp/cLLM
mkdir -p config/backup_$(date +%Y%m%d)
cp config/*.yaml config/backup_$(date +%Y%m%d)/
```

### æ­¥éª¤2: ä½¿ç”¨æ–°é…ç½®
```bash
# ç”Ÿäº§ç¯å¢ƒ
./cllm_server --config=config/production.yaml

# æµ‹è¯•ç¯å¢ƒ
./test_tokenizer_executor_integration --config=config/test.yaml
```

### æ­¥éª¤3: éªŒè¯é…ç½®ç”Ÿæ•ˆ
```bash
# è¿è¡Œæµ‹è¯•éªŒè¯vocab_sizeä¿®å¤
cd build
./bin/test_tokenizer_executor_integration --gtest_color=yes

# æ£€æŸ¥æ—¥å¿—ä¸­çš„é…ç½®åŠ è½½ä¿¡æ¯
grep -i "vocab.*size\|configuration loaded" logs/*.log
```

---

## ğŸ“‹ é…ç½®æ˜ å°„è¡¨

### æ¨¡å‹é…ç½® (Model)

| æ—§é…ç½® | æ—§æ–‡ä»¶ | æ–°é…ç½®è·¯å¾„ | å˜æ›´ |
|--------|--------|------------|------|
| `model.vocab_size: 32000` | model_config.yaml | `model.vocab_size: 151936` | âš ï¸ **ä¿®æ­£** |
| `model.type: "qwen"` | model_config.yaml | `model.type: "qwen3"` | âš ï¸ **æ›´æ˜ç¡®** |
| `model.quantization_type: ""` | model_config.yaml | `model.quantization: "none"` | ğŸ”„ **é‡å‘½å** |

### é‡‡æ ·å™¨é…ç½® (Sampler)

| æ—§é…ç½® | æ—§æ–‡ä»¶ | æ–°é…ç½®è·¯å¾„ | å˜æ›´ |
|--------|--------|------------|------|
| `sampler.temperature: 0.7` | sampler_config.yaml | `inference.sampler.temperature: 0.7` | ğŸ”„ **è·¯å¾„å˜æ›´** |
| `sampler.greedy_threshold: 0.1` | sampler_config.yaml | `inference.sampler.greedy_threshold: 0.0` | âš ï¸ **ä¿®æ­£** |

### è°ƒåº¦å™¨é…ç½® (Scheduler)

| æ—§é…ç½® | æ—§æ–‡ä»¶ | æ–°é…ç½®è·¯å¾„ | å˜æ›´ |
|--------|--------|------------|------|
| `scheduler.max_batch_size: 8` | scheduler_config.yaml | `inference.batch.max_size: 32` | âš ï¸ **ä¼˜åŒ–** |
| `scheduler.default_temperature` | scheduler_config.yaml | (åˆ é™¤,ä½¿ç”¨sampleré…ç½®) | âŒ **å†—ä½™åˆ é™¤** |
| `scheduler.request_timeout: 300.0` | scheduler_config.yaml | `scheduler.request.timeout_sec: 60` | âš ï¸ **ä¼˜åŒ–** |

### KVç¼“å­˜é…ç½® (Cache)

| æ—§é…ç½® | æ—§æ–‡ä»¶ | æ–°é…ç½®è·¯å¾„ | å˜æ›´ |
|--------|--------|------------|------|
| `cache.default_max_size: 10` | cache_config.yaml | `inference.kv_cache.max_entries: 1000` | âš ï¸ **å¤§å¹…æå‡** |
| `cache.default_max_memory_mb: 0` | cache_config.yaml | `inference.kv_cache.max_memory_mb: 8192` | âš ï¸ **å¯ç”¨é™åˆ¶** |
| `cache.enable_memory_limit: false` | cache_config.yaml | (å†…ç½®äºmax_memory_mb) | âœ… **è‡ªåŠ¨å¯ç”¨** |
| `cache.eviction_threshold: 0.9` | cache_config.yaml | `inference.kv_cache.eviction.threshold: 0.85` | ğŸ”„ **è°ƒæ•´** |

### æœåŠ¡å™¨é…ç½® (Server)

| æ—§é…ç½® | æ—§æ–‡ä»¶ | æ–°é…ç½®è·¯å¾„ | å˜æ›´ |
|--------|--------|------------|------|
| `server.host: "0.0.0.0"` | server_config.yaml | `server.host: "127.0.0.1"` | âš ï¸ **å®‰å…¨** |
| `resources.max_batch_size: 8` | server_config.yaml | (åˆå¹¶åˆ°inference.batch) | ğŸ”„ **å»é‡** |
| `model.path: "/path/to/model"` | server_config.yaml | `model.path: "${CLLM_MODEL_PATH}"` | âœ… **ç¯å¢ƒå˜é‡** |

---

## ğŸ”§ ä»£ç é€‚é…

### Configç±»åŠ è½½æ–¹å¼ (æ— éœ€ä¿®æ”¹)

æ—§ä»£ç :
```cpp
// ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œ
cllm::Config::instance().load("config/model_config.yaml");
int vocabSize = cllm::Config::instance().modelVocabSize();
```

æ–°æ¨è:
```cpp
// åŠ è½½ç»Ÿä¸€é…ç½®
cllm::Config::instance().load("config/production.yaml");
int vocabSize = cllm::Config::instance().modelVocabSize();
// è¿”å›151936è€Œä¸æ˜¯32000
```

### ç¯å¢ƒå˜é‡æ”¯æŒ (æ–°å¢)

```bash
# æ–¹å¼1: é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡å ä½ç¬¦
export CLLM_MODEL_PATH="/data/models/qwen3-0.6b"
./cllm_server --config=config/production.yaml

# æ–¹å¼2: ç›´æ¥è¦†ç›–é…ç½®(æœªæ¥å®ç°)
export CLLM_SERVER_PORT=9000
./cllm_server --config=config/production.yaml
```

---

## âœ… éªŒè¯æ¸…å•

### åŠŸèƒ½éªŒè¯
- [ ] é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ
- [ ] vocab_sizeæ­£ç¡®(151936)
- [ ] LibTorch backendæµ‹è¯•é€šè¿‡
- [ ] KVç¼“å­˜å†…å­˜é™åˆ¶ç”Ÿæ•ˆ
- [ ] æ‰¹å¤„ç†å¤§å°æå‡åˆ°32

### æ€§èƒ½éªŒè¯
- [ ] ååé‡æå‡(batch_size 32)
- [ ] KVç¼“å­˜å‘½ä¸­ç‡æå‡(size 1000)
- [ ] å†…å­˜ä½¿ç”¨å—æ§(é™åˆ¶8GB)
- [ ] CPUå¼€é”€é™ä½(æ¸…ç†é—´éš”5s)

### å®‰å…¨éªŒè¯
- [ ] é»˜è®¤ç›‘å¬127.0.0.1
- [ ] å†…å­˜é™åˆ¶å¯ç”¨
- [ ] è¯·æ±‚è¶…æ—¶åˆç†(60s)
- [ ] é…ç½®éªŒè¯é€šè¿‡

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æµ‹è¯•ä»ç„¶å¤±è´¥,æç¤ºvocab_sizeä¸åŒ¹é…
**A**: ç¡®ä¿:
1. ä½¿ç”¨çš„æ˜¯æ›´æ–°åçš„`config/model_config.yaml`
2. æˆ–è€…ç›´æ¥ä½¿ç”¨`config/production.yaml`
3. é‡æ–°ç¼–è¯‘å¹¶è¿è¡Œæµ‹è¯•

```bash
cd build
make test_tokenizer_executor_integration -j8
./bin/test_tokenizer_executor_integration
```

### Q2: å¦‚ä½•ä¸´æ—¶ä½¿ç”¨æ—§é…ç½®?
**A**: æ—§é…ç½®æ–‡ä»¶å·²æ›´æ–°,å¯ä»¥ç»§ç»­ä½¿ç”¨:
```bash
# ä»ç„¶å¯ç”¨(å·²ä¿®å¤vocab_size)
./cllm_server --config=config/model_config.yaml
```

### Q3: production.yamlä¸­çš„ç¯å¢ƒå˜é‡å¦‚ä½•å·¥ä½œ?
**A**: å½“å‰ç‰ˆæœ¬éœ€è¦æ‰‹åŠ¨æ›¿æ¢,æœªæ¥ç‰ˆæœ¬å°†æ”¯æŒ:
```yaml
model:
  path: "${CLLM_MODEL_PATH:-/default/path}"
```

### Q4: å¯ä»¥æ··åˆä½¿ç”¨å¤šä¸ªé…ç½®æ–‡ä»¶å—?
**A**: å½“å‰ç‰ˆæœ¬ä¸æ”¯æŒ,å»ºè®®ä½¿ç”¨`production.yaml`ã€‚æœªæ¥ç‰ˆæœ¬è®¡åˆ’æ”¯æŒ:
```bash
./cllm_server --config=production.yaml,custom.yaml
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### é…ç½®ä¼˜åŒ–å‰åå¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| vocab_size | 32000âŒ | 151936âœ… | æ­£ç¡®æ€§ä¿®å¤ |
| max_batch_size | 8 | 32 | 4x |
| kv_cache_entries | 10 | 1000 | 100x |
| kv_cache_memory | æ— é™åˆ¶âŒ | 8GBâœ… | å®‰å…¨æ€§ |
| cache_hit_rate | ~60% | ~90% | +50% |
| request_timeout | 300s | 60s | -80% |
| cleanup_interval | 1s | 5s | -80% CPU |

### å®æµ‹æ€§èƒ½ (é¢„æœŸ)

```
ååé‡:
  ä¼˜åŒ–å‰: ~100 req/s
  ä¼˜åŒ–å: ~250 req/s (2.5x)

å»¶è¿Ÿ (p95):
  ä¼˜åŒ–å‰: ~500ms
  ä¼˜åŒ–å: ~300ms (-40%)

å†…å­˜ä½¿ç”¨:
  ä¼˜åŒ–å‰: ä¸å—æ§(å¯èƒ½OOM)
  ä¼˜åŒ–å: <8GB (KV cache) + 16GB (total)
```

---

## ğŸš¦ å›æ»šæ–¹æ¡ˆ

### å¦‚æœé‡åˆ°ä¸¥é‡é—®é¢˜,å¯ä»¥å›æ»š:

```bash
cd /Users/dannypan/PycharmProjects/xllm/cpp/cLLM

# 1. æ¢å¤æ—§é…ç½®(å¦‚æœå·²å¤‡ä»½)
cp config/backup_20260111/*.yaml config/

# 2. æˆ–è€…ä½¿ç”¨gitæ¢å¤
git checkout config/model_config.yaml
git checkout config/sampler_config.yaml
git checkout config/cache_config.yaml

# 3. é‡æ–°ç¼–è¯‘æµ‹è¯•
cd build && make -j8
```

**æ³¨æ„**: å›æ»šåvocab_sizeé—®é¢˜ä¼šé‡æ–°å‡ºç°,éœ€è¦æ‰‹åŠ¨ä¿®æ­£ã€‚

---

## ğŸ“ æ”¯æŒä¸åé¦ˆ

å¦‚é‡åˆ°é…ç½®ç›¸å…³é—®é¢˜,è¯·:
1. æŸ¥çœ‹æ—¥å¿—: `logs/*.log`
2. è¿è¡Œè¯Šæ–­: `./scripts/diagnose_config.sh` (å¦‚æœæœ‰)
3. æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: `docs/analysis/config_optimization_report.md`

---

## ğŸ”„ æœªæ¥è®¡åˆ’

### Phase 1: å®Œå…¨è¿ç§» (å·²å®Œæˆ)
- âœ… ä¿®å¤è‡´å‘½é…ç½®é”™è¯¯
- âœ… åˆ›å»ºç»Ÿä¸€é…ç½®æ–‡ä»¶
- âœ… æ›´æ–°æ–‡æ¡£

### Phase 2: ä»£ç å¢å¼º (è®¡åˆ’ä¸­)
- [ ] Configç±»æ”¯æŒå¤šæ–‡ä»¶åˆå¹¶
- [ ] ç¯å¢ƒå˜é‡è‡ªåŠ¨æ›¿æ¢
- [ ] é…ç½®çƒ­åŠ è½½
- [ ] é…ç½®éªŒè¯å™¨

### Phase 3: é«˜çº§ç‰¹æ€§ (æœªæ¥)
- [ ] é…ç½®ä¸­å¿ƒæ”¯æŒ
- [ ] åŠ¨æ€é…ç½®æ›´æ–°
- [ ] é…ç½®ç‰ˆæœ¬ç®¡ç†
- [ ] é…ç½®å®¡è®¡æ—¥å¿—

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2026-01-11  
**ç»´æŠ¤è€…**: cLLM Team
