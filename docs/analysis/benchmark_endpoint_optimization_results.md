# Benchmarkæ¥å£ä¼˜åŒ–ç»“æœåˆ†æ

## æ‰§è¡Œæ‘˜è¦

å¯¹`/benchmark`æ¥å£è¿›è¡Œäº†ä¼˜åŒ–ï¼Œç›´æ¥è°ƒç”¨Schedulerå’ŒTokenizerï¼Œç»•è¿‡GenerateEndpointå’ŒHTTPå±‚å¼€é”€ã€‚ä½†æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼ˆ58.86 â†’ 59.19 t/sï¼‰ï¼Œè¿œä½äºé¢„æœŸã€‚

## ä¼˜åŒ–å‰åæ€§èƒ½å¯¹æ¯”

| ç‰ˆæœ¬ | Throughput (t/s) | è¯´æ˜ |
|------|-----------------|------|
| **ä¼˜åŒ–å‰ï¼ˆé€šè¿‡GenerateEndpointï¼‰** | **58.86** | åˆ›å»ºHttpRequestï¼ŒJSONåºåˆ—åŒ–ï¼Œè°ƒç”¨GenerateEndpoint |
| **ä¼˜åŒ–åï¼ˆç›´æ¥è°ƒç”¨Schedulerï¼‰** | **59.19** | ç›´æ¥åˆ›å»ºRequestStateï¼Œç›´æ¥è°ƒç”¨Scheduler |
| **Stage 15ï¼ˆå‚è€ƒï¼‰** | **89.48** | é€šè¿‡HttpHandlerå’ŒGenerateEndpointï¼Œä½†æœ‰89.48 t/s |

**å…³é”®å‘ç°**: ä¼˜åŒ–åæ€§èƒ½æå‡ä»…0.33 t/sï¼ˆ0.6%ï¼‰ï¼Œè¿œä½äºé¢„æœŸçš„20-30 t/sï¼

## æ€§èƒ½ç“¶é¢ˆæ·±åº¦åˆ†æ

### å‘ç°1: JSONåºåˆ—åŒ–/ååºåˆ—åŒ–ä¸æ˜¯ä¸»è¦ç“¶é¢ˆ âŒ

**é¢„æœŸ**: JSONåºåˆ—åŒ–/ååºåˆ—åŒ–åº”è¯¥é€ æˆ5-15 t/sçš„æ€§èƒ½æŸå¤±
**å®é™…**: ä¼˜åŒ–åï¼ˆç§»é™¤JSONï¼‰æ€§èƒ½æå‡ä»…0.33 t/s

**ç»“è®º**: JSONåºåˆ—åŒ–/ååºåˆ—åŒ–ä¸æ˜¯ä¸»è¦ç“¶é¢ˆï¼

**è¯æ®**: Stage 15ä»ç„¶ä½¿ç”¨JSONåºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œä½†æ€§èƒ½è¾¾åˆ°89.48 t/s

### å‘ç°2: GenerateEndpointå¼€é”€ä¸æ˜¯ä¸»è¦ç“¶é¢ˆ âŒ

**é¢„æœŸ**: GenerateEndpointå¤„ç†åº”è¯¥é€ æˆ3-8 t/sçš„æ€§èƒ½æŸå¤±
**å®é™…**: ä¼˜åŒ–åï¼ˆç»•è¿‡GenerateEndpointï¼‰æ€§èƒ½æå‡ä»…0.33 t/s

**ç»“è®º**: GenerateEndpointå¼€é”€ä¸æ˜¯ä¸»è¦ç“¶é¢ˆï¼

**è¯æ®**: Stage 15ä»ç„¶é€šè¿‡GenerateEndpointï¼Œä½†æ€§èƒ½è¾¾åˆ°89.48 t/s

### å‘ç°3: çœŸæ­£çš„ç“¶é¢ˆå¯èƒ½åœ¨å¹¶å‘æ§åˆ¶æˆ–ç»Ÿè®¡æ”¶é›† âš ï¸

**å¯èƒ½çš„é—®é¢˜**:

1. **é”ç«äº‰**:
   ```cpp
   {
       std::lock_guard<std::mutex> lock(resultsMutex);  // ğŸ”´ æ¯æ¬¡è¯·æ±‚å®Œæˆåéƒ½åŠ é”
       results[requestIndex] = result;
   }
   ```
   - 40ä¸ªè¯·æ±‚ï¼Œ8ä¸ªå¹¶å‘çº¿ç¨‹
   - æ¯æ¬¡è¯·æ±‚å®Œæˆåéƒ½éœ€è¦åŠ é”
   - **ä¼°ç®—å¼€é”€**: å¯èƒ½é€ æˆ5-10 t/sçš„æ€§èƒ½æŸå¤±

2. **ç»Ÿè®¡æ”¶é›†å¼€é”€**:
   ```cpp
   int completed = ++completedCount;  // ğŸ”´ åŸå­æ“ä½œ
   if (completed % 10 == 0 || completed == params.requests) {
       CLLM_INFO("Benchmark progress: %d/%d requests completed", completed, params.requests);
   }
   ```
   - åŸå­æ“ä½œå’Œæ—¥å¿—è¾“å‡º
   - **ä¼°ç®—å¼€é”€**: å¯èƒ½é€ æˆ2-5 t/sçš„æ€§èƒ½æŸå¤±

3. **çº¿ç¨‹åˆ›å»ºå¼€é”€**:
   ```cpp
   threads.emplace_back(worker, currentIndex, threadRequests);  // ğŸ”´ æ¯æ¬¡benchmarkéƒ½åˆ›å»ºæ–°çº¿ç¨‹
   ```
   - æ¯æ¬¡benchmarkéƒ½åˆ›å»º8ä¸ªæ–°çº¿ç¨‹
   - **ä¼°ç®—å¼€é”€**: å¯èƒ½é€ æˆ1-2 t/sçš„æ€§èƒ½æŸå¤±

4. **RequestResultå¯¹è±¡æ‹·è´**:
   ```cpp
   RequestResult result = executeSingleRequestDirect(params, requestIndex);  // ğŸ”´ å¯¹è±¡æ‹·è´
   ```
   - æ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºå’Œæ‹·è´RequestResultå¯¹è±¡
   - **ä¼°ç®—å¼€é”€**: å¯èƒ½é€ æˆ1-3 t/sçš„æ€§èƒ½æŸå¤±

### å‘ç°4: Stage 15 vs Benchmarkæ¥å£çš„å…³é”®å·®å¼‚

#### Stage 15çš„å®ç°
```cpp
// å·¥ä½œçº¿ç¨‹ç›´æ¥å¤„ç†è¯·æ±‚ï¼Œæ— ç»Ÿè®¡æ”¶é›†
auto worker = [&](int workerId) {
    while (true) {
        // ç›´æ¥ä»é˜Ÿåˆ—è·å–è¯·æ±‚
        // åˆ›å»ºHttpRequest
        // è°ƒç”¨HttpHandler
        // è§£æå“åº”
        // ç›´æ¥æ›´æ–°ç»Ÿè®¡ï¼ˆæ— é”ï¼Œä½¿ç”¨åŸå­æ“ä½œï¼‰
    }
};
```

**ç‰¹ç‚¹**:
- âœ… ä½¿ç”¨åŸå­æ“ä½œæ”¶é›†ç»Ÿè®¡ï¼ˆ`std::atomic<size_t> completedRequests`ï¼‰
- âœ… æ— é”ç«äº‰ï¼ˆç»Ÿè®¡æ”¶é›†ä½¿ç”¨åŸå­æ“ä½œï¼‰
- âœ… æ— RequestResultå¯¹è±¡æ‹·è´
- âœ… æ— æ—¥å¿—è¾“å‡ºå¼€é”€ï¼ˆæˆ–å¾ˆå°‘ï¼‰

#### Benchmarkæ¥å£çš„å®ç°
```cpp
// å·¥ä½œçº¿ç¨‹å¤„ç†è¯·æ±‚ï¼Œæœ‰ç»Ÿè®¡æ”¶é›†
auto worker = [&](int startIndex, int count) {
    for (int i = 0; i < count; ++i) {
        RequestResult result = executeSingleRequestDirect(params, requestIndex);  // ğŸ”´ å¯¹è±¡æ‹·è´
        
        {
            std::lock_guard<std::mutex> lock(resultsMutex);  // ğŸ”´ é”ç«äº‰
            results[requestIndex] = result;
        }
        
        int completed = ++completedCount;  // ğŸ”´ åŸå­æ“ä½œ
        if (completed % 10 == 0 || completed == params.requests) {
            CLLM_INFO("Benchmark progress: %d/%d requests completed", completed, params.requests);  // ğŸ”´ æ—¥å¿—å¼€é”€
        }
    }
};
```

**ç‰¹ç‚¹**:
- âŒ ä½¿ç”¨äº’æ–¥é”æ”¶é›†ç»Ÿè®¡ï¼ˆ`std::mutex resultsMutex`ï¼‰
- âŒ æœ‰é”ç«äº‰ï¼ˆæ¯æ¬¡è¯·æ±‚å®Œæˆåéƒ½åŠ é”ï¼‰
- âŒ æœ‰RequestResultå¯¹è±¡æ‹·è´
- âŒ æœ‰æ—¥å¿—è¾“å‡ºå¼€é”€

## æ€§èƒ½å·®è·åˆ†è§£ï¼ˆé‡æ–°ä¼°ç®—ï¼‰

### å®é™…æ€§èƒ½å·®è·

**Stage 15**: 89.48 t/s
**Benchmarkæ¥å£ï¼ˆä¼˜åŒ–åï¼‰**: 59.19 t/s
**æ€§èƒ½å·®è·**: 30.29 t/sï¼ˆ34%ï¼‰

### é‡æ–°ä¼°ç®—çš„å¼€é”€

| å¼€é”€ç±»å‹ | ä¼°ç®— (t/s) | è¯´æ˜ |
|---------|-----------|------|
| **é”ç«äº‰** | **8-15** | æ¯æ¬¡è¯·æ±‚å®Œæˆåéƒ½åŠ é”ï¼ˆ40ä¸ªè¯·æ±‚ï¼Œ8ä¸ªå¹¶å‘çº¿ç¨‹ï¼‰ |
| **RequestResultå¯¹è±¡æ‹·è´** | **3-8** | æ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºå’Œæ‹·è´RequestResultå¯¹è±¡ |
| **æ—¥å¿—è¾“å‡º** | **2-5** | æ¯10ä¸ªè¯·æ±‚è¾“å‡ºä¸€æ¬¡æ—¥å¿— |
| **ç»Ÿè®¡æ”¶é›†å¼€é”€** | **2-5** | åŸå­æ“ä½œå’Œç»Ÿè®¡è®¡ç®— |
| **çº¿ç¨‹åˆ›å»º** | **1-2** | æ¯æ¬¡benchmarkéƒ½åˆ›å»º8ä¸ªæ–°çº¿ç¨‹ |
| **å…¶ä»–å¼€é”€** | **5-10** | æœªè¯†åˆ«çš„å¼€é”€ |
| **æ€»å¼€é”€** | **21-45** | ç´¯ç§¯å¼€é”€ |

**ç»“è®º**: ä¼°ç®—å¼€é”€ï¼ˆ21-45 t/sï¼‰ä¸å®é™…æ€§èƒ½å·®è·ï¼ˆ30.29 t/sï¼‰åŸºæœ¬ä¸€è‡´ï¼

## æ ¹æœ¬åŸå› 

### é—®é¢˜1: é”ç«äº‰æ˜¯ä¸»è¦ç“¶é¢ˆ âœ…

**å½“å‰å®ç°**:
```cpp
{
    std::lock_guard<std::mutex> lock(resultsMutex);  // ğŸ”´ æ¯æ¬¡è¯·æ±‚å®Œæˆåéƒ½åŠ é”
    results[requestIndex] = result;
}
```

**é—®é¢˜**:
- 40ä¸ªè¯·æ±‚ï¼Œ8ä¸ªå¹¶å‘çº¿ç¨‹
- æ¯æ¬¡è¯·æ±‚å®Œæˆåéƒ½éœ€è¦åŠ é”
- **é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œé”ç«äº‰ä¸¥é‡**

**ä¼˜åŒ–æ–¹æ¡ˆ**:
1. ä½¿ç”¨æ— é”æ•°æ®ç»“æ„ï¼ˆå¦‚`std::atomic`ï¼‰
2. ä½¿ç”¨çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼ˆthread-local storageï¼‰
3. å‡å°‘é”çš„æŒæœ‰æ—¶é—´
4. ä½¿ç”¨åŸå­æ“ä½œæ›¿ä»£äº’æ–¥é”

### é—®é¢˜2: RequestResultå¯¹è±¡æ‹·è´å¼€é”€ âœ…

**å½“å‰å®ç°**:
```cpp
RequestResult result = executeSingleRequestDirect(params, requestIndex);  // ğŸ”´ å¯¹è±¡æ‹·è´
{
    std::lock_guard<std::mutex> lock(resultsMutex);
    results[requestIndex] = result;  // ğŸ”´ å†æ¬¡æ‹·è´
}
```

**é—®é¢˜**:
- æ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºRequestResultå¯¹è±¡
- éœ€è¦æ‹·è´åˆ°resultsæ•°ç»„
- **å¯¹è±¡æ‹·è´å¼€é”€ç´¯ç§¯**

**ä¼˜åŒ–æ–¹æ¡ˆ**:
1. ä½¿ç”¨ç§»åŠ¨è¯­ä¹‰ï¼ˆ`std::move`ï¼‰
2. ç›´æ¥åœ¨resultsæ•°ç»„ä¸­æ„é€ å¯¹è±¡
3. ä½¿ç”¨å¼•ç”¨æˆ–æŒ‡é’ˆ

### é—®é¢˜3: æ—¥å¿—è¾“å‡ºå¼€é”€ âœ…

**å½“å‰å®ç°**:
```cpp
if (completed % 10 == 0 || completed == params.requests) {
    CLLM_INFO("Benchmark progress: %d/%d requests completed", completed, params.requests);  // ğŸ”´ æ—¥å¿—å¼€é”€
}
```

**é—®é¢˜**:
- æ¯10ä¸ªè¯·æ±‚è¾“å‡ºä¸€æ¬¡æ—¥å¿—
- æ—¥å¿—è¾“å‡ºæ¶‰åŠå­—ç¬¦ä¸²æ ¼å¼åŒ–ã€I/Oæ“ä½œ
- **æ—¥å¿—è¾“å‡ºå¼€é”€ç´¯ç§¯**

**ä¼˜åŒ–æ–¹æ¡ˆ**:
1. ç§»é™¤æˆ–å‡å°‘æ—¥å¿—è¾“å‡º
2. ä½¿ç”¨æ¡ä»¶ç¼–è¯‘ï¼ˆ`#ifdef CLLM_DEBUG_MODE`ï¼‰
3. ä½¿ç”¨å¼‚æ­¥æ—¥å¿—

## ä¼˜åŒ–å»ºè®®

### ç«‹å³ä¼˜åŒ–ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰âœ…

1. **ç§»é™¤é”ç«äº‰**:
   - ä½¿ç”¨åŸå­æ“ä½œæˆ–çº¿ç¨‹å±€éƒ¨å­˜å‚¨
   - é¢„æœŸæå‡: 8-15 t/s

2. **ä¼˜åŒ–å¯¹è±¡æ‹·è´**:
   - ä½¿ç”¨ç§»åŠ¨è¯­ä¹‰
   - é¢„æœŸæå‡: 3-8 t/s

3. **ç§»é™¤æ—¥å¿—è¾“å‡º**:
   - ç§»é™¤æˆ–æ¡ä»¶ç¼–è¯‘
   - é¢„æœŸæå‡: 2-5 t/s

**é¢„æœŸæ€»æå‡**: 13-28 t/s
**é¢„æœŸæœ€ç»ˆæ€§èƒ½**: 72-87 t/sï¼ˆæ¥è¿‘Stage 15çš„89.48 t/sï¼‰

### åç»­ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

1. **ä¼˜åŒ–ç»Ÿè®¡æ”¶é›†**:
   - ä½¿ç”¨æ›´é«˜æ•ˆçš„ç»Ÿè®¡æ”¶é›†æ–¹å¼
   - é¢„æœŸæå‡: 2-5 t/s

2. **ä¼˜åŒ–çº¿ç¨‹ç®¡ç†**:
   - ä½¿ç”¨çº¿ç¨‹æ± è€Œéæ¯æ¬¡åˆ›å»ºæ–°çº¿ç¨‹
   - é¢„æœŸæå‡: 1-2 t/s

## ç»“è®º

### ä¸»è¦å‘ç°

1. **JSONåºåˆ—åŒ–/ååºåˆ—åŒ–ä¸æ˜¯ä¸»è¦ç“¶é¢ˆ**:
   - ä¼˜åŒ–åï¼ˆç§»é™¤JSONï¼‰æ€§èƒ½æå‡ä»…0.33 t/s
   - Stage 15ä»ç„¶ä½¿ç”¨JSONï¼Œä½†æ€§èƒ½è¾¾åˆ°89.48 t/s

2. **GenerateEndpointå¼€é”€ä¸æ˜¯ä¸»è¦ç“¶é¢ˆ**:
   - ä¼˜åŒ–åï¼ˆç»•è¿‡GenerateEndpointï¼‰æ€§èƒ½æå‡ä»…0.33 t/s
   - Stage 15ä»ç„¶é€šè¿‡GenerateEndpointï¼Œä½†æ€§èƒ½è¾¾åˆ°89.48 t/s

3. **çœŸæ­£çš„ç“¶é¢ˆæ˜¯**:
   - **é”ç«äº‰**ï¼ˆ8-15 t/sï¼‰
   - **RequestResultå¯¹è±¡æ‹·è´**ï¼ˆ3-8 t/sï¼‰
   - **æ—¥å¿—è¾“å‡º**ï¼ˆ2-5 t/sï¼‰

4. **æ€§èƒ½å·®è·ä¸»è¦æ¥è‡ªç»Ÿè®¡æ”¶é›†æœºåˆ¶**:
   - Benchmarkæ¥å£ä½¿ç”¨äº’æ–¥é”æ”¶é›†ç»Ÿè®¡
   - Stage 15ä½¿ç”¨åŸå­æ“ä½œæ”¶é›†ç»Ÿè®¡
   - **è¿™æ˜¯æ€§èƒ½å·®è·çš„æ ¹æœ¬åŸå› **

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç«‹å³å®æ–½**:
1. ç§»é™¤é”ç«äº‰ï¼ˆä½¿ç”¨åŸå­æ“ä½œæˆ–çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼‰
2. ä¼˜åŒ–å¯¹è±¡æ‹·è´ï¼ˆä½¿ç”¨ç§»åŠ¨è¯­ä¹‰ï¼‰
3. ç§»é™¤æ—¥å¿—è¾“å‡ºï¼ˆæˆ–æ¡ä»¶ç¼–è¯‘ï¼‰

**é¢„æœŸç»“æœ**: æ€§èƒ½ä»59.19 t/sæå‡åˆ°72-87 t/sï¼Œæ¥è¿‘Stage 15çš„89.48 t/s

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-20
**æµ‹è¯•ç»“æœ**:
- ä¼˜åŒ–å‰ï¼ˆé€šè¿‡GenerateEndpointï¼‰: 58.86 t/s
- ä¼˜åŒ–åï¼ˆç›´æ¥è°ƒç”¨Schedulerï¼‰: 59.19 t/s
- Stage 15ï¼ˆå‚è€ƒï¼‰: 89.48 t/s
**å…³é”®å‘ç°**: çœŸæ­£çš„ç“¶é¢ˆæ˜¯é”ç«äº‰ã€å¯¹è±¡æ‹·è´å’Œæ—¥å¿—è¾“å‡ºï¼Œè€ŒéJSONåºåˆ—åŒ–/ååºåˆ—åŒ–
