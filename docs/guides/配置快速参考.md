# cLLM 配置快速参考

> 一页纸快速了解cLLM配置系统

---

## 🚀 快速开始

### 使用生产配置(推荐)
```bash
./cllm_server --config=config/production.yaml
```

### 使用测试配置
```bash
./test_app --config=config/test.yaml
```

---

## 📁 配置文件说明

| 文件 | 用途 | 优先级 | 状态 |
|------|------|--------|------|
| `production.yaml` | 生产环境统一配置 | ⭐⭐⭐ 推荐 | ✅ 最新 |
| `test.yaml` | 测试环境覆盖配置 | ⭐⭐⭐ 推荐 | ✅ 最新 |
| `model_config.yaml` | 模型配置 | ⭐⭐ 兼容 | ✅ 已修复 |
| `sampler_config.yaml` | 采样器配置 | ⭐⭐ 兼容 | ✅ 已修复 |
| `scheduler_config.yaml` | 调度器配置 | ⭐⭐ 兼容 | ⚠️ 有冗余 |
| `cache_config.yaml` | 缓存配置 | ⭐⭐ 兼容 | ✅ 已优化 |
| `server_config.yaml` | 服务器配置 | ⭐⭐ 兼容 | ⚠️ 有冗余 |

---

## ⚙️ 关键配置项

### 模型配置
```yaml
model:
  type: "qwen3"
  vocab_size: 151936        # ⚠️ 必须是151936(Qwen3)
  max_sequence_length: 2048
```

### 推理配置
```yaml
inference:
  batch:
    max_size: 32            # 批处理大小(推荐32)
    timeout_ms: 500
  
  sampler:
    temperature: 0.7        # [0.0-2.0] 采样温度
    top_k: 50              # [-1=禁用] Top-K
    top_p: 0.9             # [0.0-1.0] Top-P
    greedy_threshold: 0.0  # 贪心阈值
  
  kv_cache:
    max_entries: 1000      # KV缓存条目数
    max_memory_mb: 8192    # ⚠️ 内存限制(8GB)
```

### 服务器配置
```yaml
server:
  host: "127.0.0.1"        # ⚠️ 默认本地(安全)
  port: 8080
  worker_threads: 8
```

### 资源管理
```yaml
resources:
  memory_limit_mb: 16384   # 总内存限制(16GB)
  inference_threads: 8
```

---

## ✅ 配置检查清单

### 必须检查 (启动前)
- [ ] `vocab_size = 151936` ✅
- [ ] `kv_cache.max_memory_mb > 0` ✅
- [ ] `memory_limit_mb` 设置合理 ✅

### 性能优化
- [ ] `batch.max_size >= 32` (高吞吐)
- [ ] `kv_cache.max_entries >= 1000` (高命中率)
- [ ] `cleanup_interval >= 5000` (降低CPU)

### 安全检查
- [ ] `server.host` 不是 `0.0.0.0`(除非必要)
- [ ] 内存限制已启用
- [ ] 请求超时合理(<= 60s)

---

## 🔧 配置验证

### 快速验证
```bash
# 检查vocab_size
grep "vocab_size" config/*.yaml
# 期望: 151936

# 检查内存限制
grep "max_memory_mb\|enable_memory_limit" config/cache_config.yaml
# 期望: max_memory_mb: 8192, enable: true
```

### 自动化验证
```bash
python3 scripts/validate_configs.py
```

---

## 🐛 常见问题

### Q1: 测试失败 "vocab size mismatch"
**A**: 修改 `config/model_config.yaml`:
```yaml
vocab_size: 151936  # 不是32000!
```

### Q2: 内存持续增长,最终OOM
**A**: 检查 `config/cache_config.yaml`:
```yaml
default_max_memory_mb: 8192  # 不是0!
enable_memory_limit: true    # 不是false!
```

### Q3: 吞吐量低
**A**: 提升批处理大小:
```yaml
inference:
  batch:
    max_size: 32  # 从8提升到32
```

### Q4: CPU使用率高
**A**: 降低清理频率:
```yaml
cache:
  cleanup_interval: 5000  # 从1000提升到5000
```

---

## 📊 配置模板

### 开发环境
```yaml
# config/dev.yaml
model:
  vocab_size: 151936
inference:
  batch:
    max_size: 8          # 小批量,快速反馈
  kv_cache:
    max_entries: 100     # 小缓存,节省内存
server:
  host: "127.0.0.1"
profiling:
  enable: true           # 开启profiling
```

### 生产环境
```yaml
# config/production.yaml (已提供)
inference:
  batch:
    max_size: 32         # 大批量,高吞吐
  kv_cache:
    max_entries: 1000    # 大缓存,高命中率
    max_memory_mb: 8192
profiling:
  enable: false          # 关闭profiling
```

### 测试环境
```yaml
# config/test.yaml (已提供)
model:
  vocab_size: 151936
inference:
  batch:
    max_size: 8
  kv_cache:
    max_entries: 100
profiling:
  enable: true
  detailed_metrics: true
```

---

## 🔗 详细文档

- **全面诊断报告**: `docs/analysis/config_optimization_report.md`
- **迁移指南**: `docs/analysis/config_migration_guide.md`
- **修复总结**: `docs/analysis/config_fixes_summary.md`

---

## 📞 获取帮助

遇到配置问题:
1. 查看日志: `logs/*.log`
2. 运行验证: `python3 scripts/validate_configs.py`
3. 查看详细文档: `docs/analysis/config_optimization_report.md`

---

**最后更新**: 2026-01-11  
**配置版本**: 2.0 (优化后)
