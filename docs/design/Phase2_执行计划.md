# Phase2_执行计划：量化支持与后端适配

## 文档信息
- **创建日期**: 2026-01-13
- **基于文档**: `docs/design/GGUF格式支持任务分解.md`
- **版本**: v1.0
- **状态**: 执行计划

---

## 1. 阶段目标
实现多种量化类型的反量化算法，完成后端适配器实现，集成 Tokenizer 支持。

## 2. 目标范围
- 实现量化反量化算法（Q4_K_M, Q5_K_M, Q8_0, F16, INT8 等）
- 实现 Kylin 后端适配器 (`loadFromModelWeights()`)
- 实现 LibTorch 后端适配器 (`loadFromModelWeights()`)
- 实现 `GGUFTokenizer` 类
- 集成到现有 Tokenizer 系统
- 编写量化算法和后端适配器测试

## 3. 前置条件
- ✅ 阶段2完成：GGUF 解析器可以加载权重数据
- ✅ 阶段2完成：`ModelWeights` 结构可以正确填充
- ✅ 有不同量化格式的 GGUF 测试文件

## 4. 预期成果
- 支持至少 5 种量化类型的反量化（Q4_K_M, Q5_K_M, Q8_0, F16, F32）
- Kylin 后端可以正确加载 GGUF 模型
- LibTorch 后端可以正确加载 GGUF 模型
- Tokenizer 可以从 GGUF 文件加载
- 所有量化类型都有对应的测试用例

---

## 5. 详细任务清单

### 任务3.1: 实现 F16 反量化算法
- **任务ID**: T3.1
- **执行内容**:
  - 实现 `dequantizeF16ToF32()` 函数
  - 处理 FP16 到 FP32 的转换
  - 使用 SIMD 优化（可选，阶段4优化）
  - 编写单元测试
- **技术要求**:
  - 精度损失 < 1e-3
  - 性能优化（SIMD）
- **交付标准**:
  - 反量化结果正确
  - 有单元测试
  - 性能测试报告
- **负责人角色**: C++ 开发工程师（量化专家）
- **预估工时**: 2 天
- **依赖关系**: T2.4

### 任务3.2: 实现 Q4_K_M 反量化算法
- **任务ID**: T3.2
- **执行内容**:
  - 研究 Q4_K_M 量化格式规范
  - 实现 `dequantizeQ4KMF32()` 函数
  - 处理量化块结构
  - 提取 scale 和 zero_point
  - 编写单元测试
- **技术要求**:
  - 精度损失 < 1e-2（量化本身有损失）
  - 参考 llama.cpp 实现
- **交付标准**:
  - 反量化结果与参考实现一致
  - 有单元测试
- **负责人角色**: C++ 开发工程师（量化专家）
- **预估工时**: 3 天
- **依赖关系**: T2.4

### 任务3.3: 实现 Q5_K_M 反量化算法
- **任务ID**: T3.3
- **执行内容**:
  - 研究 Q5_K_M 量化格式规范
  - 实现 `dequantizeQ5KMF32()` 函数
  - 处理量化块结构
  - 编写单元测试
- **技术要求**:
  - 精度损失 < 1e-2
  - 参考 llama.cpp 实现
- **交付标准**:
  - 反量化结果正确
  - 有单元测试
- **负责人角色**: C++ 开发工程师（量化专家）
- **预估工时**: 3 天
- **依赖关系**: T2.4

### 任务3.4: 实现 Q8_0 反量化算法
- **任务ID**: T3.4
- **执行内容**:
  - 研究 Q8_0 量化格式规范
  - 实现 `dequantizeQ8ToF32()` 函数
  - 处理量化块结构
  - 编写单元测试
- **技术要求**:
  - 精度损失 < 1e-3
  - 参考 llama.cpp 实现
- **交付标准**:
  - 反量化结果正确
  - 有单元测试
- **负责人角色**: C++ 开发工程师（量化专家）
- **预估工时**: 2 天
- **依赖关系**: T2.4

### 任务3.5: 实现通用反量化接口
- **任务ID**: T3.5
- **执行内容**:
  - 实现 `dequantizeTensor()` 方法
  - 根据量化类型路由到对应的反量化函数
  - 统一错误处理
  - 集成到 `loadTensorToWeightData()` 中
- **技术要求**:
  - 支持所有已实现的量化类型
  - 错误处理完善
- **交付标准**:
  - 可以处理所有量化类型
  - 有集成测试
- **负责人角色**: C++ 开发工程师
- **预估工时**: 2 天
- **依赖关系**: T3.1, T3.2, T3.3, T3.4

### 任务3.6: 实现 Kylin 后端适配器
- **任务ID**: T3.6
- **执行内容**:
  - 修改 `src/inference/kylin_backend.cpp`
  - 实现 `loadFromModelWeights()` 方法
  - 实现 `convertWeightToTensor()` 辅助方法
  - 转换 embedding 权重
  - 转换各层权重
  - 转换 finalNorm 和 lmHead 权重
- **技术要求**:
  - 内存拷贝高效
  - 错误处理完善
- **交付标准**:
  - Kylin 后端可以加载 GGUF 模型
  - 有集成测试
- **负责人角色**: C++ 开发工程师
- **预估工时**: 3 天
- **依赖关系**: T2.4, T1.1

### 任务3.7: 实现 LibTorch 后端适配器
- **任务ID**: T3.7
- **执行内容**:
  - 修改 `src/inference/libtorch_backend.cpp`
  - 实现 `loadFromModelWeights()` 方法
  - 实现 `convertToTorchTensor()` 辅助方法
  - 构建权重名称映射字典
  - 实现 `buildModel()` 方法（如果需要）
  - 调用 `load_state_dict()` 加载权重
- **技术要求**:
  - 支持 CPU 和 GPU 设备
  - 权重名称映射正确
- **交付标准**:
  - LibTorch 后端可以加载 GGUF 模型
  - 有集成测试
- **负责人角色**: C++ 开发工程师（LibTorch 专家）
- **预估工时**: 4 天
- **依赖关系**: T2.4, T1.1, T1.4

### 任务3.8: 实现 GGUFTokenizer
- **任务ID**: T3.8
- **执行内容**:
  - 创建 `include/cllm/tokenizer/gguf_tokenizer.h`
  - 创建 `src/tokenizer/gguf_tokenizer.cpp`
  - 实现 `GGUFTokenizer` 类
  - 从 `GGUFMetadata` 构建 Tokenizer
  - 实现 `encode()` 方法
  - 实现 `decode()` 方法
  - 支持多种 Tokenizer 类型
- **技术要求**:
  - 与现有 Tokenizer 接口兼容
  - 支持 BPE, SentencePiece 等类型
- **交付标准**:
  - 可以正确编码/解码文本
  - 有单元测试
- **负责人角色**: C++ 开发工程师
- **预估工时**: 4 天
- **依赖关系**: T2.5

### 任务3.9: 集成 Tokenizer 到现有系统
- **任务ID**: T3.9
- **执行内容**:
  - 修改 Tokenizer 工厂类
  - 添加 GGUF Tokenizer 支持
  - 更新 Tokenizer 管理器
  - 编写集成测试
- **技术要求**:
  - 保持向后兼容
  - 自动检测 Tokenizer 类型
- **交付标准**:
  - Tokenizer 可以自动从 GGUF 文件加载
  - 有集成测试
- **负责人角色**: C++ 开发工程师
- **预估工时**: 2 天
- **依赖关系**: T3.8

### 任务3.10: 编写量化与后端适配测试
- **任务ID**: T3.10
- **执行内容**:
  - 创建不同量化格式的测试文件
  - 编写反量化算法测试
  - 编写后端适配器集成测试
  - 编写端到端测试（加载模型并推理）
- **技术要求**:
  - 测试覆盖所有量化类型
  - 测试覆盖两个后端
- **交付标准**:
  - 所有测试用例通过
  - 测试覆盖率报告
- **负责人角色**: 测试工程师
- **预估工时**: 3 天
- **依赖关系**: T3.1-T3.9

---

## 6. 并行执行策略

### 可并行任务
- T3.1-T3.4 (各种反量化算法) 可以完全并行开发
- T3.6 (Kylin后端适配器) 和 T3.7 (LibTorch后端适配器) 可以并行开发
- T3.8 (GGUFTokenizer) 可以与其他任务并行

---

## 7. 关键路径分析

### 关键路径
```
T3.1-T3.4 → T3.5 → T3.10
T3.6-T3.9 → T3.10
```

**关键路径总时长**: 约 3-4 周

---

## 8. 资源分配建议

### 人员配置
- C++ 开发工程师: 2-3 人
- C++ 开发工程师（量化专家）: 1 人
- C++ 开发工程师（LibTorch 专家）: 1 人
- 测试工程师: 1 人

### 技能要求
- 熟悉 C++17
- 了解量化算法
- 熟悉 LibTorch/PyTorch C++ API
- 有 Tokenizer 实现经验
- 熟悉 Google Test 框架

---

## 9. 风险与应对

### 技术风险
| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|---------|
| 量化算法实现困难 | 中 | 高 | 参考 llama.cpp 实现，提前技术预研 |
| LibTorch 集成复杂 | 中 | 中 | 提前验证可行性，准备备选方案 |
| Tokenizer 类型支持不足 | 低 | 中 | 优先支持主要 Tokenizer 类型 |

### 进度风险
| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|---------|
| 开发周期延长 | 中 | 中 | 分阶段实施，优先核心量化类型 |
| 测试文件准备不及时 | 低 | 中 | 提前准备不同量化格式的测试文件 |

---

## 10. 交付物清单

### 代码交付物
- [ ] `src/model/gguf_loader.cpp` (修改) - 反量化算法实现
- [ ] `src/inference/kylin_backend.cpp` (修改) - Kylin 后端适配器
- [ ] `src/inference/libtorch_backend.cpp` (修改) - LibTorch 后端适配器
- [ ] `include/cllm/tokenizer/gguf_tokenizer.h` - GGUF Tokenizer
- [ ] `src/tokenizer/gguf_tokenizer.cpp` - GGUF Tokenizer 实现

### 测试交付物
- [ ] `tests/test_gguf_quantization.cpp` - 量化算法测试
- [ ] `tests/test_gguf_backend.cpp` - 后端适配器测试
- [ ] `tests/test_gguf_tokenizer.cpp` - Tokenizer 测试
- [ ] 测试覆盖率报告

---

**文档结束**