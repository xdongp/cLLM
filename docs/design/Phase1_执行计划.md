# Phase1_执行计划：GGUF 解析器实现

## 文档信息
- **创建日期**: 2026-01-13
- **基于文档**: `docs/design/GGUF格式支持任务分解.md`
- **版本**: v1.0
- **状态**: 执行计划

---

## 1. 阶段目标
实现完整的 GGUF 文件解析功能，包括文件头解析、元数据提取、张量数据加载，支持 GGUF 格式规范 v3。

## 2. 目标范围
- 实现 `GGUFLoader` 类
- 实现 GGUF 文件头解析 (`parseHeader()`)
- 实现元数据解析 (`parseMetadata()`)
- 实现张量数据加载 (`parseTensorData()`)
- 实现 `loadWeights()` 方法，返回 `ModelWeights`
- 实现 Tokenizer 元数据加载
- 编写 GGUF 解析器单元测试

## 3. 前置条件
- ✅ 阶段1完成：通用权重数据结构可用
- ✅ 阶段1完成：`IModelLoader` 接口已定义
- ✅ 有可用的 GGUF 测试文件（至少包含 F32 格式）

## 4. 预期成果
- `GGUFLoader` 可以正确解析 GGUF 文件头
- 可以提取所有元数据（模型配置、架构参数等）
- 可以加载张量数据到 `ModelWeights` 结构
- 支持 GGUF 格式规范 v3
- 单元测试覆盖所有解析功能

---

## 5. 详细任务清单

### 任务2.1: 实现 GGUF 文件头解析
- **任务ID**: T2.1
- **执行内容**:
  - 创建 `include/cllm/model/gguf_loader.h`
  - 创建 `src/model/gguf_loader.cpp`
  - 定义 `GGUFHeader` 结构体
  - 实现 `parseHeader()` 方法
  - 验证魔数 (`0x46554747`)
  - 验证版本号（支持 v3）
  - 读取张量数量和元数据数量
- **技术要求**:
  - 处理字节序（小端/大端）
  - 错误处理完善
  - 支持 GGUF v3 格式
- **交付标准**:
  - 可以正确解析文件头
  - 有单元测试
  - 错误情况处理正确
- **负责人角色**: C++ 开发工程师
- **预估工时**: 2 天
- **依赖关系**: T1.2

### 任务2.2: 实现元数据解析
- **任务ID**: T2.2
- **执行内容**:
  - 定义 `GGUFMetadata` 结构体
  - 实现 `parseMetadata()` 方法
  - 解析模型配置参数（hiddenSize, numLayers, vocabSize 等）
  - 解析架构特定参数（ropeTheta, rmsNormEps 等）
  - 解析量化参数
  - 构建元数据键值对映射
- **技术要求**:
  - 支持字符串、整数、浮点数、布尔值类型
  - 处理数组类型
  - 错误处理完善
- **交付标准**:
  - 可以正确解析所有元数据
  - 有单元测试覆盖所有数据类型
- **负责人角色**: C++ 开发工程师
- **预估工时**: 3 天
- **依赖关系**: T2.1

### 任务2.3: 实现张量数据加载
- **任务ID**: T2.3
- **执行内容**:
  - 实现 `parseTensorData()` 方法
  - 读取张量信息表
  - 解析张量名称、形状、类型
  - 记录张量数据偏移量
  - 构建张量名称到偏移量的映射
- **技术要求**:
  - 支持所有 GGUF 数据类型
  - 处理对齐要求
  - 内存映射支持（可选）
- **交付标准**:
  - 可以正确解析张量信息
  - 偏移量计算正确
  - 有单元测试
- **负责人角色**: C++ 开发工程师
- **预估工时**: 3 天
- **依赖关系**: T2.2

### 任务2.4: 实现 loadWeights() 方法
- **任务ID**: T2.4
- **执行内容**:
  - 实现 `loadWeights(ModelWeights&)` 方法
  - 实现 `loadTensorToWeightData()` 辅助方法
  - 加载 embedding 权重
  - 加载各层权重（wq, wk, wv, wo, wGate, wUp, wDown, norm1, norm2）
  - 加载 finalNorm 和 lmHead 权重
  - 处理 F32 格式（先实现，量化格式在阶段3）
- **技术要求**:
  - 使用 `ModelWeights` 结构
  - 错误处理完善
  - 内存管理正确
- **交付标准**:
  - 可以正确加载 F32 格式权重
  - 权重数据正确填充到 `ModelWeights`
  - 有集成测试
- **负责人角色**: C++ 开发工程师
- **预估工时**: 4 天
- **依赖关系**: T2.3, T1.1

### 任务2.5: 实现 Tokenizer 元数据加载
- **任务ID**: T2.5
- **执行内容**:
  - 实现 `loadTokenizerMetadata()` 方法
  - 从 GGUF 元数据提取 Tokenizer 配置
  - 解析词汇表
  - 解析合并规则
  - 解析特殊 Token ID（BOS, EOS, PAD, UNK）
- **技术要求**:
  - 支持多种 Tokenizer 类型（BPE, SentencePiece 等）
  - 错误处理完善
- **交付标准**:
  - 可以正确提取 Tokenizer 元数据
  - 有单元测试
- **负责人角色**: C++ 开发工程师
- **预估工时**: 2 天
- **依赖关系**: T2.2

### 任务2.6: 编写 GGUF 解析器测试
- **任务ID**: T2.6
- **执行内容**:
  - 创建 `tests/test_gguf_loader.cpp`
  - 编写文件头解析测试
  - 编写元数据解析测试
  - 编写张量加载测试
  - 编写 `loadWeights()` 集成测试
  - 创建测试用的 GGUF 文件（F32 格式）
- **技术要求**:
  - 使用 Google Test 框架
  - 测试覆盖率达到 85%+
  - 使用真实的 GGUF 文件测试
- **交付标准**:
  - 所有测试用例通过
  - 测试覆盖率报告
- **负责人角色**: 测试工程师
- **预估工时**: 3 天
- **依赖关系**: T2.1, T2.2, T2.3, T2.4

---

## 6. 并行执行策略

### 可并行任务
- T2.1 (文件头解析) 完成后，T2.2 (元数据解析) 和 T2.3 (张量数据加载) 可以部分并行
- T2.5 (Tokenizer元数据) 依赖 T2.2，但可以与 T2.4 (loadWeights) 并行开发

---

## 7. 关键路径分析

### 关键路径
```
T2.1 → T2.2 → T2.3 → T2.4 → T2.6
```

**关键路径总时长**: 约 3-4 周

---

## 8. 资源分配建议

### 人员配置
- C++ 开发工程师: 2-3 人
- 测试工程师: 1 人

### 技能要求
- 熟悉 C++17
- 了解文件 I/O 操作
- 了解字节序处理
- 熟悉 Google Test 框架

---

## 9. 风险与应对

### 技术风险
| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|---------|
| 字节序处理错误 | 中 | 高 | 使用标准库处理字节序，增加单元测试 |
| 元数据类型解析复杂 | 中 | 中 | 分步骤实现，每种类型单独测试 |

### 进度风险
| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|---------|
| 开发周期延长 | 低 | 中 | 分阶段实施，优先核心功能 |
| 测试文件准备不及时 | 低 | 低 | 提前准备测试文件 |

---

## 10. 交付物清单

### 代码交付物
- [ ] `include/cllm/model/gguf_loader.h` - GGUF 加载器
- [ ] `src/model/gguf_loader.cpp` - GGUF 加载器实现

### 测试交付物
- [ ] `tests/test_gguf_loader.cpp` - GGUF 解析器测试
- [ ] 测试用的 GGUF 文件（F32 格式）
- [ ] 测试覆盖率报告

---

**文档结束**