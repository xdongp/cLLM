# 工程编译设计文档

## 1. 概述

本文档描述了cLLM（C++ LLM推理引擎）的编译环境配置、依赖管理、编译步骤和编译选项。

## 2. 编译环境要求

### 2.1 操作系统支持
- **推荐**: Linux (Ubuntu 20.04+, CentOS 7+)
- **支持**: macOS (10.15+)
- **支持**: Windows 10/11 (使用MSYS2或WSL2)

### 2.2 编译器要求
- **GCC**: 9.0+ (推荐 11.0+)
- **Clang**: 10.0+ (推荐 13.0+)
- **MSVC**: 2019+ (Windows)
- **C++标准**: C++17

### 2.3 构建工具
- **CMake**: 3.15+ (推荐 3.20+)
- **Make**: 3.81+ (或Ninja)
- **Git**: 2.0+ (用于获取依赖)

### 2.4 其他工具
- **pkg-config**: 用于查找库文件
- **curl**: 用于下载依赖
- **tar**: 用于解压文件

## 3. 依赖库管理

### 3.1 必需依赖

#### 3.1.1 BS::thread_pool
- **版本**: 3.5.0+
- **类型**: Header-only
- **用途**: 高性能线程池
- **安装方式**: 
  - 下载到 `third_party/BS_thread_pool.hpp`
  - 或使用包管理器: `vcpkg install bs-thread-pool`

#### 3.1.2 Threads库
- **来源**: CMake内置
- **用途**: 多线程支持
- **安装方式**: CMake自动处理

### 3.2 可选依赖

#### 3.2.1 Google Test (GTest)
- **版本**: 1.11.0+
- **用途**: 单元测试框架
- **安装方式**:
  ```bash
  # Ubuntu/Debian
  sudo apt-get install libgtest-dev
  
  # macOS
  brew install googletest
  
  # 或从源码编译
  git clone https://github.com/google/googletest.git
  cd googletest
  mkdir build && cd build
  cmake ..
  make
  sudo make install
  ```

#### 3.2.2 mimalloc
- **版本**: 2.0.0+
- **用途**: 高性能内存分配器
- **安装方式**:
  ```bash
  # Ubuntu/Debian
  sudo apt-get install libmimalloc-dev
  
  # macOS
  brew install mimalloc
  
  # 或从源码编译
  git clone https://github.com/microsoft/mimalloc.git
  cd mimalloc
  mkdir build && cd build
  cmake ..
  make
  sudo make install
  ```

#### 3.2.3 spdlog
- **版本**: 1.9.0+
- **用途**: 高性能日志库
- **安装方式**:
  ```bash
  # Ubuntu/Debian
  sudo apt-get install libspdlog-dev
  
  # macOS
  brew install spdlog
  
  # 或从源码编译
  git clone https://github.com/gabime/spdlog.git
  cd spdlog
  mkdir build && cd build
  cmake ..
  make
  sudo make install
  ```

#### 3.2.4 nlohmann/json
- **版本**: 3.10.0+
- **类型**: Header-only
- **用途**: JSON处理
- **安装方式**:
  ```bash
  # Ubuntu/Debian
  sudo apt-get install nlohmann-json3-dev
  
  # macOS
  brew install nlohmann-json
  
  # 或下载到 include 目录
  wget https://github.com/nlohmann/json/releases/download/v3.10.5/json.hpp
  ```

## 4. 编译配置

### 4.1 CMake配置选项

| 选项 | 默认值 | 说明 |
|------|--------|------|
| `CMAKE_BUILD_TYPE` | `Release` | 构建类型: Debug/Release/RelWithDebInfo/MinSizeRel |
| `CMAKE_CXX_STANDARD` | `17` | C++标准 |
| `BUILD_TESTS` | `ON` | 是否编译测试 |
| `BUILD_EXAMPLES` | `ON` | 是否编译示例 |
| `ENABLE_SANITIZERS` | `OFF` | 是否启用地址/线程/内存检查 |
| `USE_MIMALLOC` | `OFF` | 是否使用mimalloc内存分配器 |
| `USE_SPDLOG` | `OFF` | 是否使用spdlog日志库 |
| `CMAKE_INSTALL_PREFIX` | `/usr/local` | 安装路径 |

### 4.2 编译器标志

#### Debug模式
```cmake
-g -O0 -Wall -Wextra -Wpedantic
```

#### Release模式
```cmake
-O3 -DNDEBUG -march=native
```

#### RelWithDebInfo模式
```cmake
-O2 -g -DNDEBUG
```

### 4.3 平台特定配置

#### Linux
```bash
cmake -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_CXX_COMPILER=g++ \
      -DCMAKE_C_COMPILER=gcc \
      ..
```

#### macOS
```bash
cmake -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_CXX_COMPILER=clang++ \
      -DCMAKE_C_COMPILER=clang \
      ..
```

#### Windows (MSVC)
```cmd
cmake -G "Visual Studio 16 2019" -A x64 ^
      -DCMAKE_BUILD_TYPE=Release ^
      ..
```

## 5. 编译步骤

### 5.1 标准编译流程

```bash
# 1. 进入项目目录
cd cpp/cLLM

# 2. 创建构建目录
mkdir -p build
cd build

# 3. 配置CMake
cmake .. -DCMAKE_BUILD_TYPE=Release

# 4. 编译
make -j$(nproc)

# 5. 可选: 安装
sudo make install
```

### 5.2 编译测试

```bash
# 在build目录下
make test

# 或使用ctest
ctest --output-on-failure
```

### 5.3 清理编译

```bash
# 清理编译产物
make clean

# 完全清理（包括CMake配置）
rm -rf build
```

## 6. 编译环境准备

### 6.1 Ubuntu/Debian

```bash
# 更新包管理器
sudo apt-get update

# 安装编译工具
sudo apt-get install -y \
    build-essential \
    cmake \
    git \
    pkg-config \
    curl \
    tar

# 安装编译器
sudo apt-get install -y \
    g++ \
    gcc

# 安装测试框架
sudo apt-get install -y libgtest-dev

# 安装可选依赖
sudo apt-get install -y \
    libmimalloc-dev \
    libspdlog-dev \
    nlohmann-json3-dev
```

### 6.2 macOS

```bash
# 安装Homebrew（如果未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 更新Homebrew
brew update

# 安装编译工具
brew install \
    cmake \
    git \
    pkg-config \
    curl

# 安装编译器（Xcode Command Line Tools）
xcode-select --install

# 安装测试框架
brew install googletest

# 安装可选依赖
brew install \
    mimalloc \
    spdlog \
    nlohmann-json
```

### 6.3 Windows (WSL2)

```bash
# 在WSL2中执行
sudo apt-get update

# 安装编译工具
sudo apt-get install -y \
    build-essential \
    cmake \
    git \
    pkg-config \
    curl \
    tar

# 安装编译器
sudo apt-get install -y \
    g++ \
    gcc

# 安装测试框架
sudo apt-get install -y libgtest-dev

# 安装可选依赖
sudo apt-get install -y \
    libmimalloc-dev \
    libspdlog-dev \
    nlohmann-json3-dev
```

## 7. 依赖库获取

### 7.1 BS::thread_pool

```bash
# 方法1: 直接下载
cd third_party
curl -L -o BS_thread_pool.hpp \
    https://raw.githubusercontent.com/bshoshany/thread-pool/master/BS_thread_pool.hpp

# 方法2: 使用git
cd third_party
git clone https://github.com/bshoshany/thread-pool.git
cp thread-pool/BS_thread_pool.hpp .
rm -rf thread-pool
```

### 7.2 Google Test

```bash
# 从源码编译
git clone https://github.com/google/googletest.git
cd googletest
mkdir build && cd build
cmake ..
make -j$(nproc)
sudo make install
```

### 7.3 mimalloc

```bash
# 从源码编译
git clone https://github.com/microsoft/mimalloc.git
cd mimalloc
mkdir build && cd build
cmake ..
make -j$(nproc)
sudo make install
```

### 7.4 spdlog

```bash
# 从源码编译
git clone https://github.com/gabime/spdlog.git
cd spdlog
mkdir build && cd build
cmake ..
make -j$(nproc)
sudo make install
```

### 7.5 nlohmann/json

```bash
# 下载header-only版本
cd include/cllm/common
curl -L -o json.hpp \
    https://github.com/nlohmann/json/releases/download/v3.10.5/json.hpp
```

## 8. 编译问题排查

### 8.1 常见编译错误

#### 8.1.1 CMake版本过低
```
CMake Error: CMake 3.15 or higher is required
```
**解决方案**: 升级CMake到3.15或更高版本

#### 8.1.2 找不到编译器
```
CMake Error: No suitable C++ compiler found
```
**解决方案**: 安装C++编译器并设置环境变量

#### 8.1.3 找不到依赖库
```
fatal error: BS_thread_pool.hpp: No such file or directory
```
**解决方案**: 确保依赖库已正确安装或下载到指定位置

#### 8.1.4 链接错误
```
undefined reference to `pthread_create'
```
**解决方案**: 确保链接了Threads库

### 8.2 编译优化建议

#### 8.2.1 使用Ninja构建系统
```bash
# 安装Ninja
sudo apt-get install ninja-build

# 使用Ninja编译
cmake -G Ninja ..
ninja
```

#### 8.2.2 使用ccache加速编译
```bash
# 安装ccache
sudo apt-get install ccache

# 配置CMake使用ccache
cmake -DCMAKE_C_COMPILER_LAUNCHER=ccache \
      -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
      ..
```

#### 8.2.3 并行编译
```bash
# 使用所有可用核心
make -j$(nproc)

# 或指定核心数
make -j8
```

## 9. 持续集成配置

### 9.1 GitHub Actions

```yaml
name: Build and Test

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ libgtest-dev
    - name: Configure CMake
      run: |
        cd cpp/cLLM
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
    - name: Build
      run: |
        cd cpp/cLLM/build
        make -j$(nproc)
    - name: Test
      run: |
        cd cpp/cLLM/build
        ctest --output-on-failure
```

### 9.2 GitLab CI

```yaml
stages:
  - build
  - test

build:
  stage: build
  script:
    - apt-get update && apt-get install -y cmake g++ libgtest-dev
    - cd cpp/cLLM
    - mkdir build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Release
    - make -j$(nproc)

test:
  stage: test
  script:
    - cd cpp/cLLM/build
    - ctest --output-on-failure
```

## 10. 编译产物

### 10.1 目录结构

```
build/
├── bin/              # 可执行文件
│   ├── basic_usage
│   ├── http_server_example
│   └── ...
├── lib/              # 库文件
│   ├── libcllm_core.a
│   └── libcllm_core.so
└── tests/            # 测试可执行文件
    ├── test_memory_monitor
    ├── test_threadpool
    └── ...
```

### 10.2 安装目录

```
/usr/local/
├── include/
│   └── cllm/         # 头文件
├── lib/              # 库文件
│   ├── libcllm_core.a
│   └── libcllm_core.so
└── bin/              # 可执行文件
```

## 11. 性能优化编译

### 11.1 启用SIMD优化

```bash
cmake -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_CXX_FLAGS="-march=native -O3" \
      ..
```

### 11.2 链时优化 (LTO)

```bash
cmake -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
      ..
```

### 11.3 Profile-Guided Optimization (PGO)

```bash
# 1. 编译带profile的版本
cmake -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_CXX_FLAGS="-fprofile-generate" \
      ..
make -j$(nproc)

# 2. 运行程序生成profile数据
./bin/basic_usage

# 3. 使用profile数据重新编译
cmake -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_CXX_FLAGS="-fprofile-use" \
      ..
make -j$(nproc)
```

## 12. 调试编译

### 12.1 启用调试信息

```bash
cmake -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_CXX_FLAGS="-g -O0 -Wall -Wextra" \
      ..
```

### 12.2 启用Sanitizer

```bash
# Address Sanitizer (检测内存错误)
cmake -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer" \
      -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address" \
      ..

# Thread Sanitizer (检测线程竞争)
cmake -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_CXX_FLAGS="-fsanitize=thread" \
      -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=thread" \
      ..

# Memory Sanitizer (检测未初始化内存)
cmake -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_CXX_FLAGS="-fsanitize=memory -fno-omit-frame-pointer" \
      -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=memory" \
      ..
```

## 13. 跨平台编译

### 13.1 交叉编译到ARM

```bash
cmake -DCMAKE_TOOLCHAIN_FILE=../cmake/arm-linux-gnueabihf.cmake \
      -DCMAKE_BUILD_TYPE=Release \
      ..
```

### 13.2 交叉编译到Windows

```bash
cmake -DCMAKE_TOOLCHAIN_FILE=../cmake/mingw-w64-x86_64.cmake \
      -DCMAKE_BUILD_TYPE=Release \
      ..
```

## 14. 编译检查清单

在开始编译前，请确认以下项目：

- [ ] 操作系统版本满足要求
- [ ] 编译器版本满足要求（GCC 9.0+ 或 Clang 10.0+）
- [ ] CMake版本满足要求（3.15+）
- [ ] 所有必需的依赖库已安装
- [ ] BS::thread_pool已下载到third_party目录
- [ ] 环境变量配置正确
- [ ] 磁盘空间充足（至少2GB）
- [ ] 网络连接正常（用于下载依赖）

## 15. 编译验证

### 15.1 编译成功标志

编译成功后，应该看到：

```
[100%] Built target cllm_core
[100%] Built target test_memory_monitor
[100%] Built target test_threadpool
...
```

### 15.2 测试验证

```bash
# 运行所有测试
ctest --output-on-failure

# 查看测试覆盖率
ctest -T Coverage
```

### 15.3 功能验证

```bash
# 运行示例程序
./bin/basic_usage
./bin/http_server_example
```

## 16. 附录

### 16.1 环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `CC` | C编译器 | 系统默认 |
| `CXX` | C++编译器 | 系统默认 |
| `CMAKE_PREFIX_PATH` | CMake查找路径 | /usr/local |
| `PKG_CONFIG_PATH` | pkg-config查找路径 | /usr/local/lib/pkgconfig |

### 16.2 有用的CMake命令

```bash
# 查看所有可用的CMake选项
cmake -L ..

# 查看高级CMake选项
cmake -LA ..

# 清理CMake缓存
rm CMakeCache.txt

# 重新生成构建文件
cmake ..
```

### 16.3 参考资源

- [CMake官方文档](https://cmake.org/documentation/)
- [GCC编译器文档](https://gcc.gnu.org/onlinedocs/)
- [Clang编译器文档](https://clang.llvm.org/docs/)
- [BS::thread_pool文档](https://github.com/bshoshany/thread-pool)
- [Google Test文档](https://google.github.io/googletest/)
