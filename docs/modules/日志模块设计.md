# 日志模块详细设计

## 编程规范
本模块遵循项目统一的[C++编程规范.md](../../C++编程规范.md)和[生成代码规范.md](../生成代码规范.md)

## 0. 要生成的文件

### 0.1 头文件（include/cllm/common/）
| 文件名 | 对应类/结构体 | 说明 |
|--------|--------------|------|
| `logger.h` | `Logger` | 日志系统核心类 |
| `log_formatter.h` | `LogFormatter` | 日志格式化器 |
| `log_sink.h` | `LogSink` | 日志输出目标抽象 |

### 0.2 源文件（src/common/）
| 文件名 | 对应头文件 | 说明 |
|--------|-----------|------|
| `logger.cpp` | `logger.h` | Logger类的实现 |
| `log_formatter.cpp` | `log_formatter.h` | 日志格式化实现 |
| `log_sinks/console_sink.cpp` | `log_sink.h` | 控制台输出实现 |
| `log_sinks/file_sink.cpp` | `log_sink.h` | 文件输出实现 |

### 0.3 测试文件（tests/）
| 文件名 | 测试目标 | 说明 |
|--------|---------|------|
| `test_logger.cpp` | Logger | 日志系统核心测试 |
| `test_log_sinks.cpp` | 各LogSink实现 | 输出目标测试 |

## 1. 模块概述

### 1.1 模块职责
- 提供分级日志输出（TRACE/DEBUG/INFO/WARN/ERROR/CRITICAL）
- 支持多日志输出目标（控制台/文件/网络等）
- 支持自定义日志格式
- 线程安全的日志记录
- 高性能异步日志记录

### 1.2 技术选型
**核心库**: spdlog
- 高性能C++日志库
- 支持异步日志
- 丰富的sink类型
- 线程安全
- 支持格式化和过滤

**辅助组件**:
- fmtlib (spdlog内置): 高性能格式化
- libfmt (可选): 扩展格式化支持

## 2. 类设计

### 2.1 类图
```
┌───────────────────────┐       ┌───────────────────────┐
│       Logger          │       │     LogFormatter      │
│  - sinks_: vector     │<>-----│  - pattern_: string   │
│  - formatter_: unique │       └───────────────────────┘
│  - level_: Level      │                ▲
└──────────┬───────────┘                │
           │                            │
           │  ┌───────────────────────┐│
           │  │       LogSink         ││
           └─>│  - formatter_: ref    ││
              │  + log(record): void  ││
              └──────────┬───────────┘│
                         △            │
             ┌───────────┴───────────┐│
             │                       ││
┌───────────────────────┐ ┌───────────────────────┐
│    ConsoleSink        │ │      FileSink         │
│  - stdout/stderr      │ │  - file_: ofstream    │
└───────────────────────┘ └───────────────────────┘
```

### 2.2 核心类说明

#### 2.2.1 Logger
- 日志系统入口
- 管理多个LogSink
- 提供分级日志接口
- 线程安全

#### 2.2.2 LogFormatter
- 定义日志格式
- 支持自定义格式字符串
- 内置常见格式（简单/详细/JSON）

#### 2.2.3 LogSink (抽象类)
- 定义日志输出接口
- 派生出具体实现（Console/File/Network等）

## 3. 接口设计

### 3.1 Logger接口
```cpp
class Logger {
public:
    enum class Level { TRACE, DEBUG, INFO, WARN, ERROR, CRITICAL };
    
    void addSink(std::unique_ptr<LogSink> sink);
    void setLevel(Level level);
    void setFormatter(std::unique_ptr<LogFormatter> formatter);
    
    template<typename... Args>
    void log(Level level, const char* fmt, const Args&... args);
    
    // 快捷方法
    template<typename... Args> void trace(const char* fmt, const Args&... args);
    template<typename... Args> void debug(const char* fmt, const Args&... args);
    // ...其他级别类似
};
```

### 3.2 LogFormatter接口
```cpp
class LogFormatter {
public:
    struct LogRecord {
        std::chrono::system_clock::time_point time;
        Logger::Level level;
        std::string message;
        std::string loggerName;
        std::thread::id threadId;
    };
    
    virtual std::string format(const LogRecord& record) = 0;
    
    // 内置格式
    static std::unique_ptr<LogFormatter> createSimpleFormatter();
    static std::unique_ptr<LogFormatter> createDetailedFormatter();
    static std::unique_ptr<LogFormatter> createJsonFormatter();
};
```

### 3.3 LogSink接口
```cpp
class LogSink {
public:
    virtual ~LogSink() = default;
    virtual void log(const LogFormatter::LogRecord& record) = 0;
    virtual void flush() = 0;
    
    void setFormatter(std::unique_ptr<LogFormatter> formatter);
protected:
    std::unique_ptr<LogFormatter> formatter_;
};
```

## 4. 实现细节

### 4.1 日志格式示例
- **简单格式**: "[INFO] This is a log message"
- **详细格式**: "2026-01-09 22:46:48 [INFO] [main.cpp:42] This is a log message"
- **JSON格式**: `{"time":"2026-01-09T22:46:48Z","level":"INFO","message":"..."}`

### 4.2 性能优化
1. **异步日志**：使用spdlog的异步日志器
2. **格式缓存**：缓存频繁使用的格式字符串
3. **批量写入**：合并小日志批量写入
4. **线程局部存储**：减少锁竞争

## 5. 使用示例

### 5.1 基本使用
```cpp
auto logger = std::make_shared<Logger>();
logger->addSink(std::make_unique<ConsoleSink>());
logger->setLevel(Logger::Level::INFO);

logger->info("System initialized, version: {}", "1.0.0");
logger->error("Failed to connect to {}", "database");
```

### 5.2 自定义格式
```cpp
auto formatter = LogFormatter::createDetailedFormatter();
logger->setFormatter(std::move(formatter));
```

### 5.3 多输出目标
```cpp
logger->addSink(std::make_unique<ConsoleSink>());
logger->addSink(std::make_unique<FileSink>("app.log"));
```

## 6. 集成方案

### 6.1 CMake配置
```cmake
find_package(spdlog REQUIRED)
target_link_libraries(cllm_core PRIVATE spdlog::spdlog)
```

### 6.2 全局日志器
```cpp
namespace cllm {
    Logger& getGlobalLogger();
}
```

## 7. 测试方案

### 7.1 单元测试
- 测试各日志级别输出
- 测试格式器正确性
- 测试sink输出正确性

### 7.2 性能测试
- 基准测试：同步vs异步性能
- 多线程压力测试

## 8. 扩展性设计
1. **自定义Sink**：继承LogSink实现新的输出目标
2. **自定义格式**：继承LogFormatter实现新格式
3. **日志过滤**：支持按模块/级别过滤