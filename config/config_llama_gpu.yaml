# cLLM 配置文件 - llama.cpp 后端 GPU 模式 (Metal)
#
# 使用 llama.cpp 后端 + Metal GPU 加速
# 这个后端的 GPU 支持更加稳定

# ============================================================
# 服务器配置
# ============================================================
server:
  host: "0.0.0.0"
  port: 8080
  num_threads: 8
  min_threads: 4

# ============================================================
# 模型配置
# ============================================================
model:
  path: "/Users/dannypan/PycharmProjects/cLLM/model/Qwen/Qwen3-0.6B"
  vocab_size: 151936
  max_context_length: 4096
  default_max_tokens: 1024
  quantization: "fp16"

# ============================================================
# HTTP 配置
# ============================================================
http:
  max_input_tokens: 2048
  timeout_ms: 120000

# ============================================================
# API 配置
# ============================================================
api:
  response:
    content_type:
      json: "application/json"
      stream: "text/event-stream"
    headers:
      cache_control: "no-cache"
      connection: "keep-alive"

  defaults:
    prompt: ""
    max_tokens: 100
    temperature: 0.7
    top_p: 0.9

  timeouts:
    min: 60.0
    max: 600.0
    token_factor: 10.0

# ============================================================
# 调度器配置
# ============================================================
scheduler:
  max_iterations: 5000
  batch_timeout_ms: 100
  max_batch_size: 32
  context_usage_threshold: 0.75

  default_temperature: 0.7
  default_top_p: 0.9
  default_top_k: 50
  default_max_tokens: 1024

  request_timeout: 300.0
  loop_interval: 5
  idle_loop_interval: 50
  wait_poll_interval_ms: 5

# ============================================================
# 资源配置
# ============================================================
resources:
  max_batch_size: 32
  max_context_length: 4096
  kv_cache_max_size: 64
  kv_cache_max_memory_mb: 8192
  memory_limit_mb: 16384

# ============================================================
# 缓存配置
# ============================================================
cache:
  default_max_size: 200
  default_max_memory_mb: 8192
  enable_lru: true
  enable_memory_limit: true
  enable_stats: true
  eviction_threshold: 0.9
  cleanup_interval: 500

# ============================================================
# 后端配置 - 使用 llama.cpp + GPU
# ============================================================
backend:
  type: "llama_cpp"

  kylin:
    device_backend: "cpu"
    operator_backend: "ggml"
    n_threads: 0

  llama_cpp:
    n_batch: 512
    n_threads: 8
    n_gpu_layers: 99       # 全部层在 GPU
    n_seq_max: 16
    use_mmap: true
    use_mlock: false
    flash_attn: true

  libtorch:
    seq_len_candidates: [8, 16, 32, 64, 128, 256]
    fallback_seq_len: 8

# ============================================================
# 动态批处理调谐器配置
# ============================================================
dynamic_batch_tuner:
  enabled: false
  strategy: "static"
  fixed_batch_size: 16
  min_batch_size: 1
  max_batch_size: 64
  initial_batch_size: 8
  probing_growth_factor: 2.0
  max_probing_attempts: 10
  time_increase_threshold: 0.30
  adjustment_factor: 0.30
  validation_interval: 50
  exploration_interval: 200
  probe_batch_count: 10
  validation_batch_count: 10
  max_consecutive_time_increases: 5

# ============================================================
# 日志配置
# ============================================================
logging:
  level: "info"
  file: ""
  max_size_mb: 100
  max_files: 5
